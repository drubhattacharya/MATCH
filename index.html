<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CHNA–CRA Navigation Dashboard — 3 Tiers</title>

  <!-- Dependencies (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Match LAI Navigation Dashboard look & feel (light, crisp, blue/green accents) */
    :root{
      --blue:#1f7fd6; --green:#18a76f; --ink:#0b1f33; --muted:#2f4556;
      --border:rgba(11,31,51,.16); --bg1:#e7f3ff; --bg2:#e7fbf2; --card:#ffffff;
      --warn:#d78b00; --bad:#d93b3b;
      --shadow:0 12px 28px rgba(11,31,51,.06);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 520px at 15% 10%, var(--bg1), rgba(255,255,255,0)),
        radial-gradient(1100px 520px at 85% 20%, var(--bg2), rgba(255,255,255,0)),
        linear-gradient(180deg, #ffffff, #f7fbff);
      color:var(--ink);
      font-size:16px;
      line-height:1.45;
    }
    header{
      padding:14px 18px 12px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.88);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:14px 18px 40px;}
    h1{margin:0;font-size:20px;}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;}
    .grid{display:grid; gap:12px;}
    .grid-2{grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;}
    button{
      border:1px solid var(--border); background:#fff; border-radius:12px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    button.primary{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    button.secondary{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    button.danger{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tabbtn{
      border:1px solid var(--border); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    .pill{
      display:inline-block; padding:2px 10px; border-radius:999px;
      background:rgba(31,127,214,.10); border:1px solid rgba(31,127,214,.22);
      font-size:12px; font-weight:800;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff;
      font-size:12px; font-weight:900; color:var(--ink);
    }
    .small{font-size:12px;color:var(--muted);}
    .mono{font-family:var(--mono);}

    .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns:1fr;} }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800;}
    .kpi .value{font-size:22px;font-weight:900;margin-top:2px;}
    .kpi .hint{font-size:12px;color:var(--muted); margin-top:4px; line-height:1.35;}

    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border:1px solid var(--border); padding:8px; vertical-align:top;}
    th{background:rgba(31,127,214,.08); text-align:left;}
    .callout{
      border:1px dashed rgba(11,31,51,.25);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.7);
    }
    .okbar{
      display:none; border:1px solid rgba(24,167,111,.35); background:rgba(24,167,111,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }
    .errbar{
      display:none; border:1px solid rgba(217,59,59,.35); background:rgba(217,59,59,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }

    .view{display:none;}
    .view.active{display:block;}

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .field{flex:1 1 320px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff;}
    .field label{display:flex; justify-content:space-between; gap:10px; font-weight:900; font-size:13px;}
    input, select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:12px;
      font-size:14px; color:var(--ink); background:#fff;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
    }
    .b-strong{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    .b-mod{border-color:rgba(215,139,0,.35); background:rgba(215,139,0,.08);}
    .b-weak{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}

    .codebox{
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      color:var(--ink);
    }

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:980px){ .split{grid-template-columns:1fr;} }

    .gate{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--warn);
      border:1px solid rgba(0,0,0,.08);
    }
    .dot.good{background: var(--green);}
    .dot.bad{background: var(--bad);}
  </style>
</head>

<body>
<header>
  <div class="wrap" style="padding:0 18px;">
    <h1>CHNA–CRA Navigation Dashboard — 3-Tier Navigation</h1>
    <div class="sub">Tier 1: CHNA Materiality • Tier 2: CRA Eligibility & Application Readiness • Tier 3: Total Program Cost & ROI</div>

    <div class="tabs" aria-label="Navigation tabs">
      <button class="tabbtn active" id="tab_overview" data-view="overview">Overview</button>
      <button class="tabbtn" id="tab_t1" data-view="t1">Tier 1 — Assessment</button>
      <button class="tabbtn" id="tab_t2" data-view="t2">Tier 2 — CRA Readiness</button>
      <button class="tabbtn" id="tab_t3" data-view="t3">Tier 3 — ROI</button>
      <button class="tabbtn" id="tab_t4" data-view="t4">Tier 4 — Implementation</button>
      <button class="tabbtn" id="tab_t5" data-view="t5">Tier 5 — Outcomes</button>
      <button class="tabbtn" id="tab_t6" data-view="t6">Tier 6 — Evaluation</button>
      <button class="tabbtn" id="tab_drafts" data-view="drafts">Artifacts</button>

      <div class="gate">
        <span class="chip"><span id="gateDot" class="dot"></span> <span id="gateText">Run Tier 1 to unlock downstream tiers</span></span>
      </div>
    </div>
  </div>
</div>
</header>

<div class="wrap">
  <div id="errbar" class="errbar"></div>
  <div id="okbar" class="okbar"></div>

  <!-- LEFT + RIGHT layout -->
  <div class="grid grid-2">
    <!-- LEFT: Upload and controls -->
    <div class="card">
      <div class="btnbar">
        <button class="primary" id="btn_process">Process Files</button>
        <button class="secondary" id="btn_demo">Load Demo (Transportation differential)</button>
        <button id="btn_export">Export report (JSON)</button>
        <button class="danger" id="btn_reset">Reset</button>
      </div>

      <div class="field" style="margin-top:8px;">
        <label><span>Upload documents</span><span class="pill">PDF/TXT</span></label>
        <input id="file_input" type="file" multiple accept=".pdf,.txt"/>
        <div class="small" style="margin-top:8px;">Processing runs locally. Large PDFs may take a minute.</div>
        <div id="proc_log" class="codebox" style="margin-top:10px; min-height:120px;">(processing log)</div>
        <div class="small" style="margin-top:8px;">
          Upload: CHNA (PDF), Schedule H (PDF), CRA exam/procedures (PDF), internal memos (TXT).
          Processing occurs locally in your browser.
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="chip">Docs: <span class="mono" id="docs_count">0</span></div>
        <div class="chip">Evidence: <span class="mono" id="ev_count">0</span></div>
        <div class="chip">Top Tier 2 score: <span class="mono" id="top_t2">—</span></div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">Transportation spotlight (required)</div>
        <div class="small" style="margin-top:6px;">
          This dashboard explicitly elevates transportation when a subgroup (e.g., ages 65–74) shows materially higher barriers than overall population.
          This is the “amplification” logic that turns a seemingly small overall rate into a partnership-grade opportunity.
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="chip">Overall transportation: <b id="t_overall">—</b></div>
          <div class="chip">Age 65–74: <b id="t_6574">—</b></div>
          <div class="chip">Amplification: <b id="t_amp">—</b></div>
        </div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">How CRA eligibility is stated here</div>
        <div class="small" style="margin-top:6px;">
          Tier 2 includes the specific qualifying criterion satisfied (e.g., “community support services targeted to LMI individuals”)
          and cites the applicable topic and example (e.g., transportation to medical treatments).
        </div>
      </div>
    </div>

    <!-- RIGHT: Views -->
    <div class="card">
      
      <!-- Overview -->
      <section id="view_overview" class="view active">
        <div class="callout">
          <div style="font-weight:900;">Platform Overview</div>
          <div class="small" style="margin-top:6px;">
            Each tier answers a distinct governance question—moving from assessment → eligibility → ROI → implementation → reporting → evaluation.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Tiered Question Framework</div>
          <div style="overflow:auto;">
            <table>
              <tr><th>Tier</th><th>Core question</th><th>Outputs</th></tr>
              <tr><td><b>Tier 1</b></td><td>Is the CHNA accountable and investment-ready?</td><td>Scores, gaps, evidence</td></tr>
              <tr><td><b>Tier 2</b></td><td>Is it CRA-eligible and exam-defensible?</td><td>Crosswalk + checklist</td></tr>
              <tr><td><b>Tier 3</b></td><td>Is it financially disciplined? What’s break-even?</td><td>ROI + break-even</td></tr>
              <tr><td><b>Tier 4</b></td><td>How do we implement?</td><td>30-60-90 plan</td></tr>
              <tr><td><b>Tier 5</b></td><td>What do we report?</td><td>Quarterly report</td></tr>
              <tr><td><b>Tier 6</b></td><td>How do we evaluate?</td><td>Evaluation plan</td></tr>
            </table>
          </div>
        </div>
      </section>


      <!-- Tier 1 -->
      <section id="view_t1" class="view">
        <div class="kpis">
          <div class="kpi"><div class="label">Structural score</div><div class="value" id="kpi_struct">—</div><div class="hint">IRS documentation completeness.</div></div>
          <div class="kpi"><div class="label">Community input status</div><div class="value" id="kpi_input">—</div><div class="hint">Written comment compliance.</div></div>
          <div class="kpi"><div class="label">CHNA–CHIP alignment</div><div class="value" id="kpi_align">—</div><div class="hint">Priority continuity + operationalization.</div></div>
          <div class="kpi"><div class="label">Investment readiness index</div><div class="value" id="kpi_iri">—</div><div class="hint">40% structural, 20% input, 40% alignment.</div></div>
        </div>
            <div class="value" id="kpi_top">—</div>
            <div class="hint" id="kpi_top_hint">Process documents to compute materiality.</div>
          </div>
          <div class="kpi">
            <div class="label">Top subgroup concentration</div>
            <div class="value" id="kpi_conc">—</div>
            <div class="hint">Highlights where a targeted program will have the strongest case.</div>
          </div>
          <div class="kpi">
            <div class="label">Priority shortlist</div>
            <div class="value" id="kpi_shortlist">—</div>
            <div class="hint">Items recommended to advance to Tier 2.</div>
          </div>
          <div class="kpi">
            <div class="label">Partner angle</div>
            <div class="small" id="kpi_angle">—</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Disparities Materiality Matrix</div>
            <div class="small" style="margin-bottom:10px;">
              Materiality score (0–100) is computed from <b>magnitude</b>, <b>subgroup differential</b>, and <b>prominence across documents</b>.
              Transportation receives a boost when subgroup amplification is detected (e.g., 8.5% vs 2.7%).
            </div>

            <div class="split">
              <div style="overflow:auto;">
                <table id="tbl_materiality"></table>
              </div>
              <div>
                <div style="font-weight:900; margin-bottom:6px;">Top disparities chart</div>
                <canvas id="chart_materiality" height="230"></canvas>
                <div class="small" style="margin-top:8px;">Chart ranks the highest scoring disparities (0–100).</div>
              </div>
            </div>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:900;">Tier 1 recommendation snapshot</div>
              <div class="small" id="tier1_recs" style="margin-top:6px;">—</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Evidence snippets (traceability)</div>
            <div class="small" style="margin-bottom:10px;">Each signal preserves the triggering text plus document and page.</div>
            <div style="overflow:auto;">
              <table id="tbl_evidence"></table>
            </div>
          </div>
        </div>
      
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">CHNA–CHIP Alignment & Operationalization</div>
          <div class="small" style="margin-bottom:10px;">Select the CHNA and CHIP documents (from uploaded PDFs) and score alignment (0–2).</div>
          <div class="row" style="margin-top:0;">
            <div class="field"><label>CHNA document</label><select id="sel_chna"></select></div>
            <div class="field"><label>CHIP/Plan document</label><select id="sel_chip"></select></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><div style="font-weight:900; margin-bottom:6px;">Detected priorities</div><div id="prio_box" class="codebox" style="min-height:220px;">Process Tier 1 to extract priorities.</div></div>
            <div><div style="font-weight:900; margin-bottom:6px;">Alignment rubric</div><div style="overflow:auto;"><table id="tbl_align"></table></div>
              <div class="row"><button class="secondary" type="button" onclick="prefillAlignment()">Auto-prefill alignment</button><button type="button" onclick="scoreAll()">Recalculate Tier 1 scores</button></div>
            </div>
          </div>
        </div>

</section>

      <!-- Tier 2 -->
      
<section id="view_t2" class="view">
  <div class="callout">
    <div style="font-weight:900;">Tier 2 — CRA Rule Engine (exam‑informed)</div>
    <div class="small" style="margin-top:6px;">
      This tier does <b>not</b> require uploading CRA documents. CRA eligibility and exam defensibility logic is embedded using large‑bank examination concepts:
      <b>primary purpose</b>, <b>LMI targeting</b>, <b>assessment area attribution</b>, <b>responsiveness</b>, and <b>documentation readiness</b>.
    </div>
  </div>

  <div class="card" style="box-shadow:none; margin-top:12px;">
    <div class="kpis">
      <div class="kpi">
        <div class="label">CRA eligibility score</div>
        <div class="value" id="cra_elig">—</div>
        <div class="hint">Primary purpose + LMI targeting + AA attribution.</div>
      </div>
      <div class="kpi">
        <div class="label">Exam defensibility score</div>
        <div class="value" id="cra_def">—</div>
        <div class="hint">Responsiveness + complexity + leadership + measurable outputs.</div>
      </div>
      <div class="kpi">
        <div class="label">Documentation readiness</div>
        <div class="value" id="cra_docs">—</div>
        <div class="hint">Are required artifacts defined and collectible?</div>
      </div>
      <div class="kpi">
        <div class="label">Tier 2 overall score</div>
        <div class="value" id="cra_total">—</div>
        <div class="hint">Tier 3 unlocks when ≥ 60 and Tier 1 IRI ≥ 55.</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field">
        <label>Activity type</label>
        <select id="cra_activity">
          <option value="nmt" selected>NEMT / Transportation‑to‑care</option>
          <option value="food">Food access support</option>
          <option value="care">Care navigation / referral infrastructure</option>
          <option value="other">Other community service</option>
        </select>
        <div class="small" style="margin-top:6px;">Pick the activity you want to structure for CRA credit.</div>
      </div>

      <div class="field">
        <label>Bank booking structure</label>
        <select id="cra_structure">
          <option value="grant" selected>Grant / donation to nonprofit partner</option>
          <option value="service">Bank staff community development service</option>
          <option value="investment">Qualified investment (e.g., CDFI support)</option>
          <option value="loan">Community development loan</option>
        </select>
        <div class="small" style="margin-top:6px;">Used to suggest documentation artifacts and exam narrative language.</div>
      </div>

      <div class="field">
        <label>Assessment area attribution (%) <span class="mono" id="cra_aa_read">100%</span></label>
        <input id="cra_aa" type="range" min="0" max="100" step="1" value="100"/>
        <div class="small" style="margin-top:6px;">Percent of beneficiaries/trips clearly attributable to the bank’s CRA assessment area.</div>
      </div>

      <div class="field">
        <label>LMI targeting (%) <span class="mono" id="cra_lmi_read">90%</span></label>
        <input id="cra_lmi" type="range" min="0" max="100" step="1" value="90"/>
        <div class="small" style="margin-top:6px;">Estimated share of beneficiaries who are low- or moderate-income (LMI).</div>
      </div>
    </div>

    <div class="callout" style="margin-top:12px;">
      <div style="font-weight:900;">Primary purpose & responsiveness</div>
      <div class="small" style="margin-top:6px;">
        CRA examiners heavily weight whether the activity is clearly responsive to documented community needs and whether documentation supports that conclusion.
        Tier 1 evidence can be used here.
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Primary purpose (community development) is clear?</label>
          <select id="cra_primary">
            <option value="2" selected>Yes — clearly targets community services for LMI individuals</option>
            <option value="1">Partially — some ambiguity; needs clarification</option>
            <option value="0">No — unclear primary purpose</option>
          </select>
        </div>

        <div class="field">
          <label>Responsiveness to documented need</label>
          <select id="cra_resp">
            <option value="2" selected>High — directly addresses a documented CHNA priority</option>
            <option value="1">Moderate — addresses need but link needs strengthening</option>
            <option value="0">Low — weak linkage to documented need</option>
          </select>
        </div>

        <div class="field">
          <label>Complexity / innovation</label>
          <select id="cra_complex">
            <option value="2">High — multi‑partner, measurable, scalable</option>
            <option value="1" selected>Moderate — standard model with strong controls</option>
            <option value="0">Low — simple donation with limited structure</option>
          </select>
        </div>

        <div class="field">
          <label>Leadership / role</label>
          <select id="cra_lead">
            <option value="2">Leader — convenes partners, anchors funding</option>
            <option value="1" selected>Participant — meaningful support</option>
            <option value="0">Minimal — passive contribution</option>
          </select>
        </div>
      </div>
    </div>

    <div class="callout" style="margin-top:12px;">
      <div style="font-weight:900;">Documentation checklist (exam‑ready)</div>
      <div class="small" style="margin-top:6px;">Check what you can produce today. Missing items become the action plan.</div>

      <div class="row" style="margin-top:10px;">
        <div class="field"><label><input type="checkbox" class="cra_doc" value="chna" checked/> CHNA/CHIP excerpt(s) supporting need</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="beneficiary" checked/> Beneficiary eligibility method (LMI or geography)</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="aa" checked/> AA attribution evidence (ZIP/tract/county)</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="agreement" checked/> Partner agreement / contract / MOU</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="invoices"/> Invoices / payments / contribution evidence</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="logs"/> Service logs / units delivered (rides, referrals, etc.)</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="monitor"/> Monitoring cadence + corrective action triggers</label></div>
        <div class="field"><label><input type="checkbox" class="cra_doc" value="report"/> Quarterly outcomes report template</label></div>
      </div>
    </div>

    <div class="btnbar" style="margin-top:12px;">
      <button class="primary" type="button" onclick="runCRAEngine()">Calculate Tier 2 score</button>
      <button class="secondary" type="button" onclick="populateCRAFromTier1()">Pull responsiveness hints from Tier 1</button>
    </div>

    <div class="split" style="margin-top:12px;">
      <div class="card" style="box-shadow:none;">
        <div style="font-weight:900; margin-bottom:6px;">Flags & recommendations</div>
        <div id="cra_flags" class="codebox" style="min-height:240px;">Run Tier 2 to generate flags and recommendations.</div>
      </div>
      <div class="card" style="box-shadow:none;">
        <div style="font-weight:900; margin-bottom:6px;">Exam‑style narrative starter</div>
        <div id="cra_narr" class="codebox" style="min-height:240px;">Run Tier 2 to generate exam-style language based on inputs.</div>
      </div>
    </div>

  </div>
</section>


      
      
      <!-- Tier 3 -->
      <section id="view_t3" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 3 — NEMT No‑Show ROI (Excel‑Parity) + Coding ROI Layer</div>
          <div class="small" style="margin-top:6px;">
            The base ROI remains <b>Excel‑parity</b> (no added fixed/startup costs). Optionally activate a <b>Coding ROI Layer</b> to model
            incremental upside from SDOH ICD‑10 Z‑code documentation and CPT reporting capture associated with improved visit completion and workflow reliability.
          </div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="callout">
            <div style="font-weight:900;">Base ROI definition (Excel‑parity)</div>
            <div class="small" style="margin-top:6px;">
              <b>Transport no‑shows</b> = Visits × No‑show rate × Transport share<br/>
              <b>Prevented no‑shows</b> = Transport no‑shows × Mitigation rate<br/>
              <b>Net benefit</b> = (Prevented × Net revenue) − (Prevented × Marginal clinical cost) − (Prevented × Trip cost × (1 + Overhead rate))
            </div>
          </div>

          <div style="font-weight:900; margin:12px 0 6px;">A) Volume & Access</div>
          <div class="row">
            <div class="field"><label>Annual targeted outpatient visits</label><input id="a_visits" type="number" value="40000"/></div>
            <div class="field"><label>No‑show rate (0.20 or 20)</label><input id="a_noshow" type="number" value="0.20" step="0.01"/></div>
            <div class="field"><label>Share due to transportation (0.30 or 30)</label><input id="a_share" type="number" value="0.30" step="0.01"/></div>
            <div class="field"><label>Net revenue per visit ($)</label><input id="a_netrev" type="number" value="225"/></div>
            <div class="field"><label>Marginal clinical cost per visit ($)</label><input id="a_margc" type="number" value="90"/></div>
          </div>

          <div style="font-weight:900; margin:10px 0;">B) Program Inputs</div>
          <div class="row">
            <div class="field"><label>Mitigation rate (0.50 or 50)</label><input id="b_mitig" type="number" value="0.50" step="0.01"/></div>
            <div class="field"><label>Trip cost ($)</label><input id="b_trip" type="number" value="60"/></div>
            <div class="field"><label>Overhead rate (0.10 or 10)</label><input id="b_over" type="number" value="0.10" step="0.01"/></div>
          </div>

          <div style="font-weight:900; margin:10px 0;">C) CRA Scope (optional for CRA outputs)</div>
          <div class="row">
            <div class="field"><label>LMI share (0.90 or 90)</label><input id="c_lmi" type="number" value="0.90" step="0.01"/></div>
            <div class="field"><label>AA share (1.00 or 100)</label><input id="c_aa" type="number" value="1.00" step="0.01"/></div>
            <div class="field"><label>Bank annual contribution ($/yr)</label><input id="c_bank" type="number" value="50000"/></div>
          </div>

          <div class="hr"></div>

          <div class="callout">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:900;">Coding ROI Layer (optional)</div>
                <div class="small" style="margin-top:6px;">
                  This layer models incremental financial upside from improved coding/documentation capture enabled by visit completion and SDOH workflow reliability.
                  It does <b>not</b> alter the base Excel-parity ROI; it adds an optional “coding uplift” line item.
                </div>
              </div>
              <div class="chip">
                <span style="font-weight:900;">Activate</span>
                <input id="toggle_coding" type="checkbox" style="margin-left:10px; transform:scale(1.2);" />
              </div>
            </div>

            <div id="coding_box" style="display:none; margin-top:10px;">
              <div class="row">
                <div class="field">
                  <label>Z‑code documentation capture rate (0–100%)</label>
                  <input id="z_rate" type="number" value="25" min="0" max="100" step="1"/>
                  <div class="small" style="margin-top:6px;">Percent of prevented visits where SDOH Z-codes are documented (e.g., Z59.*, Z60.*, Z63.*, Z75.*).</div>
                </div>
                <div class="field">
                  <label>Estimated $ uplift per Z‑coded encounter</label>
                  <input id="z_uplift" type="number" value="20" min="0" step="1"/>
                  <div class="small" style="margin-top:6px;">Conservative placeholder (e.g., improved reimbursement capture, care coordination value, risk documentation).</div>
                </div>
                <div class="field">
                  <label>CPT capture uplift rate (0–100%)</label>
                  <input id="cpt_rate" type="number" value="15" min="0" max="100" step="1"/>
                  <div class="small" style="margin-top:6px;">Percent of prevented visits where additional coding/quality capture occurs (e.g., Category II reporting, documentation completeness).</div>
                </div>
                <div class="field">
                  <label>Estimated $ uplift per CPT‑captured encounter</label>
                  <input id="cpt_uplift" type="number" value="15" min="0" step="1"/>
                  <div class="small" style="margin-top:6px;">Conservative placeholder (e.g., downcoding protection, quality program attribution, operational billing confidence).</div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Apply coding uplift to</label>
                  <select id="coding_base">
                    <option value="prevented" selected>Prevented no‑shows (recovered visits)</option>
                    <option value="all">All targeted visits (broad workflow uplift)</option>
                  </select>
                  <div class="small" style="margin-top:6px;">Default is conservative: apply only to recovered visits.</div>
                </div>
                <div class="field">
                  <label>Notes (optional)</label>
                  <input id="coding_notes" type="text" placeholder="e.g., Z75.3 transportation barrier documented via screening; CPT II captured for quality reporting."/>
                </div>
              </div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" onclick="render_roi()">Run ROI</button>
          </div>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi"><div class="label">Net Annual Benefit (base, Excel‑parity)</div><div class="value" id="o_net">—</div></div>
            <div class="kpi"><div class="label">Coding uplift (optional)</div><div class="value" id="o_code">—</div></div>
            <div class="kpi"><div class="label">Net benefit incl. coding uplift</div><div class="value" id="o_total_net">—</div></div>
            <div class="kpi"><div class="label">ROI incl. coding uplift (x)</div><div class="value" id="o_roi">—</div></div>
          </div>

          <div class="split" style="margin-top:12px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">ROI decomposition</div>
              <canvas id="roi_bar" height="260"></canvas>
              <div class="small" style="margin-top:8px;">Base ROI bars are Excel parity; coding uplift is displayed separately.</div>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">CRA impact outputs</div>
              <div id="cra_box" class="codebox" style="min-height:260px;">Run ROI to populate outputs.</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none; margin-top:12px;">
            <div style="font-weight:900; margin-bottom:6px;">Audit‑ready output</div>
            <div id="roi_audit" class="codebox">Run ROI to generate memo output.</div>
          </div>
        </div>
      </section>



      
      <!-- Tier 4 -->
      <section id="view_t4" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 4 — Implementation Plan (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier turns the selected Tier 2 opportunity into an executable plan: roles, timeline, workflow, data capture, and audit artifacts.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">30‑60‑90 Day Implementation Plan</div>
          <div class="small" style="margin-bottom:10px;">Auto-populated from Tier 2 selection and Tier 3 ROI assumptions when available.</div>
          <div id="impl_plan" class="codebox" style="min-height:260px;">Run Tier 3 and select an opportunity to generate an implementation plan.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_impl_plan()">Generate plan</button>
            <button onclick="copy_block('impl_plan')">Copy</button>
          </div>
        </div>
      </section>

      <!-- Tier 5 -->
      <section id="view_t5" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 5 — Outcomes Reporting (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier defines the reporting package for hospitals and banks: operational outputs, beneficiary counts, CRA metrics, and financial performance updates.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Quarterly Outcomes Report Template</div>
          <div class="small" style="margin-bottom:10px;">Includes CRA outputs (LMI trips, AA trips, bank $/LMI trip) and hospital operational KPIs.</div>
          <div id="outcomes_report" class="codebox" style="min-height:260px;">Run Tier 3 to populate a draft outcomes report template.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_outcomes_report()">Generate report</button>
            <button onclick="copy_block('outcomes_report')">Copy</button>
          </div>
        </div>
      </section>

      <!-- Tier 6 -->
      <section id="view_t6" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 6 — Evaluation Plan (prototype)</div>
          <div class="small" style="margin-top:6px;">
            This tier formalizes evaluation: baseline, comparison approach, data sources, metrics, and governance for continuous improvement and CRA defensibility.
          </div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Evaluation Plan Template</div>
          <div class="small" style="margin-bottom:10px;">Designed for audit and re-use across projects (NEMT and broader SDOH interventions).</div>
          <div id="eval_plan" class="codebox" style="min-height:260px;">Generate an evaluation plan using Tier 1 evidence + Tier 2 criteria + Tier 3 assumptions.</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="secondary" onclick="generate_eval_plan()">Generate plan</button>
            <button onclick="copy_block('eval_plan')">Copy</button>
          </div>
        </div>
      </section>

<!-- Drafts -->
      <section id="view_drafts" class="view">
        <div class="callout">
          <div style="font-weight:900;">CRA Application Draft Generator</div>
          <div class="small" style="margin-top:6px;">
            Use the dropdowns to generate exam‑defensible draft artifacts from the dashboard analysis (Tier 1–3). 
            Drafts pull from uploaded evidence (disparity measures + citations), Tier 2 eligibility criterion and scope guidance,
            and the most recent Tier 3 cost/ROI scenario (when run).
          </div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="row">
            <div class="field">
              <label>Artifact type</label>
              <select id="draft_type">
                <option value="cra_memo">CRA Activity Justification Memo</option>
                <option value="exam_narrative">Examiner‑Facing Narrative (PE language)</option>
                <option value="crosswalk">CRA Eligibility Crosswalk Table</option>
                <option value="term_sheet">Joint Partnership Term Sheet (working draft)</option>
                <option value="chna_brief">CHNA Implementation Alignment Brief</option>
                <option value="monitor_plan">Monitoring & Evidence Plan</option>
                <option value="pnl">Borrower P&L Statement (Hospital)</option>
                <option value="proforma_3yr">Project Pro Forma Budget (3-Year)</option>
              </select>
              <div class="small" style="margin-top:6px;">Choose the document you want to generate. Everything is editable after download.</div>
            </div>

            <div class="field">
              <label>Opportunity / Activity</label>
              <select id="draft_activity">
                <option value="auto">Auto (Top Tier 2)</option>
                <option value="nmt">Transportation‑to‑care (NEMT)</option>
                <option value="food">Food access support</option>
                <option value="care">Care navigation / referral infrastructure</option>
              </select>
              <div class="small" style="margin-top:6px;">Default uses the highest‑scoring Tier 2 opportunity.</div>
            </div>

            <div class="field">
              <label>Voice & tone</label>
              <select id="draft_tone">
                <option value="bank">Bank CRA file (formal)</option>
                <option value="joint" selected>Joint bank–hospital memo (board‑ready)</option>
                <option value="hospital">Hospital internal approval (ops/finance)</option>
              </select>
              <div class="small" style="margin-top:6px;">Changes emphasis, not the underlying facts.</div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" id="btn_generate_draft">Generate Draft</button>
            <button id="btn_copy_draft">Copy</button>
            <button class="secondary" id="btn_download_draft">Download .txt</button>
          </div>

          <div class="split" style="margin-top:10px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Preview</div>
              <div id="draft_preview" class="codebox" style="min-height:340px;">Select an artifact type and click <b>Generate Draft</b>.</div>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Quick controls</div>
              <div class="small" style="margin-bottom:10px;">
                These fields are optional. They allow quick tailoring without editing after export.
              </div>
              <div class="row">
                <div class="field">
                  <label>Project name (optional)</label>
                  <input id="draft_project_name" type="text" placeholder="e.g., Senior Access Shuttle — 12‑month pilot"/>
                </div>
                <div class="field">
                  <label>Implementing partner (optional)</label>
                  <input id="draft_partner" type="text" placeholder="e.g., County Transit / Nonprofit / Ride broker"/>
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label>Pro forma growth (%/yr)</label>
                  <input id="draft_growth" type="number" value="5" min="0" step="0.5"/>
                </div>
                <div class="field">
                  <label>Cost inflation (%/yr)</label>
                  <input id="draft_infl" type="number" value="3" min="0" step="0.5"/>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Assessment area notes (optional)</label>
                  <input id="draft_scope_note" type="text" placeholder="e.g., Target ZIPs 56xxx within AA; document beneficiary location."/>
                </div>
                <div class="field">
                  <label>Funding structure (optional)</label>
                  <input id="draft_structure" type="text" placeholder="e.g., CRA‑credited grant to nonprofit; service agreement with hospital."/>
                </div>
              </div>

              <div class="callout" style="margin-top:10px;">
                <div style="font-weight:900;">Tip</div>
                <div class="small" style="margin-top:6px;">
                  Run Tier 3 (<b>Cost & ROI</b>) first to populate the draft with a program cost baseline and break‑even assumptions.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
  // ------------------------------
  // PDF.js setup
  // ------------------------------
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // ------------------------------
  // Utilities
  // ------------------------------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function fmtPct(x){ return (x==null || isNaN(x)) ? "—" : `${x.toFixed(1)}%`; }
  function fmtInt(x){ return (x==null || isNaN(x)) ? "—" : `${Math.round(x).toLocaleString()}`; }
  function fmtMoney(x){
    if(x==null || isNaN(x)) return "—";
    const sign = x < 0 ? "-" : "";
    const v = Math.abs(x);
    return `${sign}$${v.toLocaleString(undefined,{maximumFractionDigits:0})}`;
  }
  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function showErr(msg){ const e=document.getElementById("errbar"); e.style.display="block"; e.innerHTML = msg; }
  function clearErr(){ const e=document.getElementById("errbar"); e.style.display="none"; e.innerHTML = ""; }
  function showOk(msg){ const o=document.getElementById("okbar"); o.style.display="block"; o.innerHTML = msg; }

  // ------------------------------
  // State
  // ------------------------------
  const state = {
    docs: [], // {name,type,pages,textByPage[]}
    evidence: [], // {disparity, snippet, doc, page}
    findings: [], // Tier1: {id,key,disparity,segment,magnitude,prominence,concentration,score,recommend,evidenceRef}
    opportunities: [], // Tier2: {opp,kind,tests,criterion,strength,score,scope,checklist}
    selectedOpp: null,
    transport: {overall:null, age6574:null}
  ,
    model: null
  };

  // Disparities list (includes transportation explicitly)
  const DISPARITIES = [
    {key:"transport", label:"Transportation barrier", keywords:["transportation","transit"], metric:"% reporting transportation problems"},
    {key:"access", label:"Access to care barrier", keywords:["could not get an appointment","delayed care"], metric:"% delaying needed care"},
    {key:"food", label:"Food insecurity", keywords:["food insecurity","food shelf"], metric:"% reporting food insecurity"},
    {key:"housing", label:"Housing need", keywords:["housing needs","housing"], metric:"% reporting housing needs"},
    {key:"financial", label:"Financial need", keywords:["financial needs","cost too much"], metric:"% reporting financial needs"}
  ];

  // CRA criteria mapping (explicit criterion satisfied)
  // Note: This is written in a regulator-friendly way, citing the OCC illustrative list structure (Topic L — community support services).
  const CRA_CRITERIA = {
    nmt: {
      criterion: "Community development services / community support services targeted to low- or moderate-income (LMI) individuals — transportation to medical treatments.",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — example: transportation to medical treatments for LMI individuals."
    },
    food: {
      criterion: "Community development services / community support services targeted to LMI individuals — food access support as a community service (when structured for LMI populations).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — community services for LMI individuals (structure matters)."
    },
    care: {
      criterion: "Community development services targeted to LMI individuals — health services / community services that improve access (depending on structure and beneficiaries).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — health/community services for LMI individuals (structure matters)."
    }
  };

  // ------------------------------
  // Extraction
  // ------------------------------
  async function extractPdfText(file){
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    const numPages = pdf.numPages;
    const textByPage = [];
    for(let p=1; p<=numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str).filter(Boolean);
      const text = strings.join(" ").replace(/\s+/g,' ').trim();
      textByPage.push(text);
    }
    return {pages: numPages, textByPage};
  }
  async function extractTxt(file){
    const text = await file.text();
    return {pages: 1, textByPage: [text.replace(/\s+/g,' ').trim()]};
  }

  function recordEvidence(disparityLabel, snippet, doc, page){
    state.evidence.push({disparity:disparityLabel, snippet, doc, page});
  }

  function findPercentNear(text, keyword){
    const re = new RegExp(`${keyword}[\\s\\S]{0,160}?(\\d{1,2}(?:\\.\\d+)?)%`, "i");
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }
  function findAge6574Transport(text){
    const re = /65\s*[-–]\s*74[\s\S]{0,160}transportation[\s\S]{0,80}?(\d{1,2}(?:\.\d+)?)%/i;
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }

  function addFinding(key, disparity, segment, magnitude, prominence, evidenceRef){
    const id = `${key}__${segment}`;
    const ex = state.findings.find(x=>x.id===id);
    if(ex){
      if(magnitude > ex.magnitude){
        ex.magnitude = magnitude;
        ex.prominence = Math.max(ex.prominence, prominence);
        ex.evidenceRef = evidenceRef;
      }
      return;
    }
    state.findings.push({
      id, key, disparity, segment, magnitude,
      prominence,
      concentration:0,
      score:0,
      recommend:"",
      evidenceRef
    });
  }

  function scanDoc(doc){
    const prominence = {};
    for(const d of DISPARITIES){ prominence[d.key]=0; }

    for(let i=0;i<doc.textByPage.length;i++){
      const t = doc.textByPage[i] || "";
      const lower = t.toLowerCase();

      // prominence by keywords
      for(const d of DISPARITIES){
        for(const kw of d.keywords){
          if(lower.includes(kw.toLowerCase())){ prominence[d.key] += 1; break; }
        }
      }

      // Transportation overall
      const tr = findPercentNear(t, "transportation");
      if(tr){
        recordEvidence("Transportation barrier", tr.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Overall", tr.val, prominence["transport"], `${doc.name} p.${i+1}`);
        if(state.transport.overall==null) state.transport.overall = tr.val;
      }
      // Transportation 65-74
      const tr6574 = findAge6574Transport(t);
      if(tr6574){
        recordEvidence("Transportation barrier", tr6574.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Age 65–74", tr6574.val, prominence["transport"], `${doc.name} p.${i+1}`);
        state.transport.age6574 = tr6574.val;
      }

      // Other disparities
      for(const d of DISPARITIES){
        if(d.key==="transport") continue;
        const primary = d.keywords[0];
        const p = findPercentNear(t, primary.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        if(p){
          recordEvidence(d.label, p.snippet, doc.name, i+1);
          addFinding(d.key, d.label, "Overall", p.val, prominence[d.key], `${doc.name} p.${i+1}`);
        }
      }
    }
  }

  function computeMateriality(){
    // Compute concentration per key (subgroup - overall)
    const byKey = {};
    for(const f of state.findings){
      if(!byKey[f.key]) byKey[f.key]=[];
      byKey[f.key].push(f);
    }
    for(const key of Object.keys(byKey)){
      const list = byKey[key];
      const overall = list.find(x=>x.segment==="Overall");
      for(const f of list){
        f.concentration = (f.segment!=="Overall" && overall) ? Math.max(0, f.magnitude - overall.magnitude) : 0;
      }
    }

    // Materiality score:
    // magnitude (0-60), concentration (0-25), prominence (0-15)
    // transportation amplification: if 65–74 exists and overall exists, add bonus up to +10
    let transportBonus = 0;
    if(state.transport.overall!=null && state.transport.age6574!=null && state.transport.overall>0){
      const amp = state.transport.age6574 / state.transport.overall;
      transportBonus = clamp((amp-1)*8, 0, 10); // up to 10 points bonus
    }

    for(const f of state.findings){
      const magScore = clamp((f.magnitude/30)*60, 0, 60);
      const concScore = clamp((f.concentration/15)*25, 0, 25);
      const promScore = clamp((f.prominence/6)*15, 0, 15);
      let score = Math.round(magScore + concScore + promScore);
      if(f.key==="transport") score = clamp(score + Math.round(transportBonus), 0, 100);
      f.score = score;
      f.recommend = (score>=70) ? "Advance (high)" : (score>=55 ? "Advance (moderate)" : "Defer/monitor");
    }
    state.findings.sort((a,b)=>b.score-a.score);
  }

  function buildOpportunities(){
    const bestByKey = {};
    for(const f of state.findings){
      if(!bestByKey[f.key]) bestByKey[f.key]=f;
    }

    // Always include transportation opportunity (requirement), score based on findings if present
    const opps = [];

    function scoreOpportunity(eligibilityClarity, responsiveness, attributionStrength, docBurden){
      return Math.round(0.30*eligibilityClarity + 0.30*responsiveness + 0.25*attributionStrength + 0.15*(100-docBurden));
    }

    // Attribution heuristic
    const attribution = 70; // default; can be enhanced later if we parse AA geos
    const scope = "Prefer AA attribution: document beneficiary location (ZIP/tract/county) and service delivery within AA; if broader, document proportional benefit.";

    // Transportation (NEMT) — explicit criterion
    {
      const f = bestByKey.transport || {score:55}; // keep it evaluable even if CHNA extraction fails
      const eligibility = 90; // strong
      const responsiveness = clamp(f.score, 0, 100);
      const burden = 35;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Transportation-to-care (NEMT) — missed appointment mitigation",
        kind:"nmt",
        tests:"Service • Investment (as structured) • CD Loans (as structured)",
        criterion: CRA_CRITERIA.nmt.criterion + " " + CRA_CRITERIA.nmt.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA excerpt(s) with overall + age-band differential; target population definition (LMI and/or qualifying segments); service area map; vendor/partner agreement; invoices; ride logs; beneficiary counts; monitoring report cadence."
      });
    }

    // Food
    if(bestByKey.food){
      const f = bestByKey.food;
      const eligibility = 80;
      const responsiveness = clamp(f.score,0,100);
      const burden = 45;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Food access support — distribution / vouchers / meal supports",
        kind:"food",
        tests:"Investment • Service (depending on structure)",
        criterion: CRA_CRITERIA.food.criterion + " " + CRA_CRITERIA.food.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA food measure; LMI targeting method; partner agreement; distribution logs; invoices; beneficiary counts; monitoring plan."
      });
    }

    // Access
    if(bestByKey.access){
      const f = bestByKey.access;
      const eligibility = 75;
      const responsiveness = clamp(f.score,0,100);
      const burden = 50;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Care navigation / referral infrastructure — access enablement",
        kind:"care",
        tests:"Service • Investment (as structured)",
        criterion: CRA_CRITERIA.care.criterion + " " + CRA_CRITERIA.care.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA access barrier evidence; workflow description; staffing records; referral counts; LMI targeting; monitoring plan."
      });
    }

    opps.sort((a,b)=>b.score-a.score);
    state.opportunities = opps;
    state.selectedOpp = opps.length ? opps[0] : null;
  }

  function tier3Unlocked(){
    return state.opportunities.some(o=>o.score>=60);
  }

  // ------------------------------
  // Rendering
  // ------------------------------
  let chartMateriality=null, chartROI=null, chartTrend=null;

  function strengthBadge(str){
    if(str==="Strong") return `<span class="badge b-strong">Strong</span>`;
    if(str==="Moderate") return `<span class="badge b-mod">Moderate</span>`;
    return `<span class="badge b-weak">Weak</span>`;
  }

  function renderTransportSpotlight(){
    const o = state.transport.overall;
    const a = state.transport.age6574;
    document.getElementById("t_overall").textContent = (o==null) ? "—" : fmtPct(o);
    document.getElementById("t_6574").textContent = (a==null) ? "—" : fmtPct(a);
    if(o!=null && a!=null && o>0){
      const amp = a/o;
      document.getElementById("t_amp").textContent = `${amp.toFixed(1)}×`;
    }else{
      document.getElementById("t_amp").textContent = "—";
    }
  }

  function renderTier1(){
    // KPIs
    if(state.findings.length){
      const top = state.findings[0];
      document.getElementById("kpi_top").textContent = `${top.disparity} (${top.score})`;
      document.getElementById("kpi_top_hint").textContent = `Magnitude ${fmtPct(top.magnitude)} • Prominence ${top.prominence} • Δ ${top.concentration.toFixed(1)}.`;
      const subs = state.findings.filter(x=>x.segment!=="Overall").sort((a,b)=>b.concentration-a.concentration);
      if(subs.length){
        const s = subs[0];
        document.getElementById("kpi_conc").textContent = `${s.disparity} Δ${s.concentration.toFixed(1)}% (${s.segment})`;
      }else{
        document.getElementById("kpi_conc").textContent = "—";
      }
      const shortlist = state.findings.filter(f=>f.score>=55).length;
      document.getElementById("kpi_shortlist").textContent = `${shortlist}`;
      const angle = (state.transport.overall!=null && state.transport.age6574!=null) ?
        "Transportation appears small overall, but materially higher in older adults — strong case for targeted NEMT." :
        "Use highest materiality disparities to form a joint bank–hospital decision memo.";
      document.getElementById("kpi_angle").textContent = angle;
    }

    // Materiality table
    const tbl = document.getElementById("tbl_materiality");
    if(!state.findings.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>No results yet.</td></tr>";
    }else{
      let html = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr>";
      for(const f of state.findings.slice(0,10)){
        html += `<tr>
          <td><b>${escapeHtml(f.disparity)}</b></td>
          <td>${escapeHtml(f.segment)}</td>
          <td class="mono">${fmtPct(f.magnitude)}</td>
          <td class="mono">${f.concentration.toFixed(1)}%</td>
          <td class="mono">${f.prominence}</td>
          <td class="mono"><b>${f.score}</b></td>
          <td>${escapeHtml(f.recommend)}</td>
          <td class="mono">${escapeHtml(f.evidenceRef||"—")}</td>
        </tr>`;
      }
      tbl.innerHTML = html;
    }

    // Materiality chart
    const top = state.findings.slice(0,8);
    const labels = top.map(f=>`${f.disparity}${f.segment!=="Overall" ? " ("+f.segment+")" : ""}`);
    const vals = top.map(f=>f.score);
    if(chartMateriality) chartMateriality.destroy();
    chartMateriality = new Chart(document.getElementById("chart_materiality"), {
      type:"bar",
      data:{labels, datasets:[{label:"Materiality (0–100)", data:vals}]},
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
          y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true, max:100}
        }
      }
    });

    // Tier 1 recs
    const rec = [];
    if(state.transport.overall!=null && state.transport.age6574!=null){
      rec.push(`Transportation: overall ${fmtPct(state.transport.overall)} vs age 65–74 ${fmtPct(state.transport.age6574)} (amplification ${(state.transport.age6574/state.transport.overall).toFixed(1)}×). Treat as a high-value access lever (missed appointments).`);
    }
    const adv = state.findings.filter(f=>f.score>=70).slice(0,3);
    if(adv.length){
      rec.push(`Advance now: ${adv.map(x=>x.disparity).join(", ")}.`);
    }else{
      rec.push("Advance now: highest scoring disparity and validate geography + target segment in Tier 2.");
    }
    rec.push("Create a joint bank–hospital memo: (1) documented need, (2) target segment/geography, (3) CRA criterion satisfied, (4) documentation plan, (5) cost baseline and KPI monitoring.");
    document.getElementById("tier1_recs").textContent = rec.join(" ");
  }

  function renderEvidence(){
    const tbl = document.getElementById("tbl_evidence");
    if(!state.evidence.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>No evidence captured yet.</td></tr>";
      return;
    }
    const slice = state.evidence.slice(-25).reverse();
    let html = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr>";
    for(const e of slice){
      html += `<tr>
        <td>${escapeHtml(e.disparity)}</td>
        <td>${escapeHtml(e.snippet)}</td>
        <td class="mono">${escapeHtml(e.doc)}</td>
        <td class="mono">${e.page}</td>
      </tr>`;
    }
    tbl.innerHTML = html;
  }

  function renderTier2(){
    const tbl = document.getElementById("tbl_cra");
    if(!state.opportunities.length){
      tbl.innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>No opportunities yet.</td></tr>";
      return;
    }
    let html = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr>";
    for(const o of state.opportunities){
      html += `<tr>
        <td><b>${escapeHtml(o.opp)}</b></td>
        <td>${escapeHtml(o.tests)}</td>
        <td>${escapeHtml(o.criterion)}</td>
        <td>${strengthBadge(o.strength)}</td>
        <td class="mono"><b>${o.score}</b></td>
        <td>${escapeHtml(o.scope)}</td>
        <td>${escapeHtml(o.checklist)}</td>
      </tr>`;
    }
    tbl.innerHTML = html;

    const top = state.opportunities[0];
    document.getElementById("t2_best").textContent = `${top.score}`;
    document.getElementById("t2_best_hint").textContent = top.opp;

    const tOpp = state.opportunities.find(x=>x.kind==="nmt");
    document.getElementById("t2_transport").textContent = tOpp ? `${tOpp.score} (${tOpp.strength})` : "—";
    document.getElementById("t2_crit").textContent = tOpp ? tOpp.criterion : "—";
    document.getElementById("t2_packet").textContent = tOpp ? "CHNA evidence + LMI targeting + AA attribution + invoices + service logs + beneficiary counts + monitoring" : "—";

    document.getElementById("top_t2").textContent = `${top.score}`;

    // Gate
    const unlocked = tier3Unlocked();
    const dot = document.getElementById("gateDot");
    dot.classList.remove("good","bad");
    if(unlocked){ dot.classList.add("good"); document.getElementById("gateText").textContent = "Tier 3 unlocked (Tier 2 score ≥ 60)"; }
    else { dot.classList.add("bad"); document.getElementById("gateText").textContent = "Tier 3 locked until Tier 2 score ≥ 60"; }

    // Prompts
    document.getElementById("exam_prompts").textContent =
      "1) Document the disparity + affected segment (CHNA excerpt with page). 2) State the CRA qualifying criterion satisfied (and why benefit is targeted to LMI/qualifying population). 3) Define assessment area attribution (who benefited, where). 4) Provide invoices/contracts and beneficiary counts. 5) Define baseline metric + monitoring cadence.";
  }

  function setTier3FromOpportunity(opp){
    if(!opp) return;
    document.getElementById("inp_activity").value = opp.kind;
    // Nudge parameters for NEMT: barrier share proxy from transport overall if present
    if(opp.kind==="nmt" && state.transport.overall!=null){
      const proxy = clamp(state.transport.overall*3.0, 5, 70);
      document.getElementById("inp_share").value = proxy.toFixed(1);
    }
  }

  function runTier3(){
    
    const activity = document.getElementById("inp_activity").value;
    const months = parseInt(document.getElementById("inp_months").value||"12",10);

    const annual = parseFloat(document.getElementById("inp_annual").value||"0");
    const baseRate = parseFloat(document.getElementById("inp_base").value||"0")/100;
    const share = parseFloat(document.getElementById("inp_share").value||"0")/100;
    const red = parseFloat(document.getElementById("inp_red").value||"0")/100;

    const covPct = parseFloat(document.getElementById("inp_cov").value||"25");
    const weightMode = document.getElementById("inp_weight_mode").value; // weighted | flat
    const senSharePct = clamp(parseFloat(document.getElementById("inp_sen_share").value||"25"), 0, 100);

    const benefitPer = parseFloat(document.getElementById("inp_benefit").value||"0");
    const startup = parseFloat(document.getElementById("inp_startup").value||"0");
    const fixed = parseFloat(document.getElementById("inp_fixed").value||"0");
    const varCost = parseFloat(document.getElementById("inp_var").value||"0");
    const unitsPer = parseFloat(document.getElementById("inp_units").value||"1");

    // Coverage and weighting logic:
    // Eligible touchpoints that receive support (targeted coverage).
    const eligibleTouchpoints = annual * (covPct/100);

    // Transport amplification factor from CHNA (65–74 vs overall) when available.
    let ampFactor = 1.0;
    if(state.transport.overall != null && state.transport.age6574 != null && state.transport.overall > 0){
      ampFactor = state.transport.age6574 / state.transport.overall; // e.g., 8.5/2.7 = 3.15x
    }
    if(weightMode === "flat") ampFactor = 1.0;

    // Effective barrier share adjusts upward when seniors are prioritized (higher transport barrier).
    const senShare = senSharePct/100;
    const effBarrierShare = clamp(share * ((1-senShare)*1.0 + (senShare*ampFactor)), 0, 1);

    // Disruptions among those offered support
    const baselineDisrupt = eligibleTouchpoints * baseRate;
    const barrierDisrupt = baselineDisrupt * effBarrierShare;
    const prevented = barrierDisrupt * red;

    // Units and benefit (annualized)
    const unitsAnnual = prevented * unitsPer;
    const grossAnnual = prevented * benefitPer;

    // cost over horizon: startup + fixed*months + variable*(annualUnits*months/12)*varCost
    const totalCostH = startup + fixed*months + (unitsAnnual*(months/12)*varCost);
    const annualCost = totalCostH*(12/months);
    const netAnnual = grossAnnual - annualCost;

    // Persist last model outputs for draft generator
    state.model = {
      activity, months, annual_touchpoints: annual,
      baseline_rate_pct: (baseRate*100),
      barrier_share_pct: (share*100),
      reduction_pct: (red*100),
      coverage_pct: Math.round(covPct),
      weight_mode: weightMode,
      seniors_share_pct: Math.round(senSharePct),
      amp_factor: (state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall) : null,
      prevented_disruptions: prevented,
      units_annual: unitsAnnual,
      startup, fixed_monthly: fixed, variable_unit_cost: varCost, units_per_prevented: unitsPer,
      total_cost_horizon: totalCostH,
      annual_cost: annualCost,
      gross_annual_benefit: grossAnnual,
      net_annual: netAnnual
    };


    document.getElementById("kpi_cost").textContent = fmtMoney(annualCost);
    document.getElementById("kpi_gross").textContent = fmtMoney(grossAnnual);
    document.getElementById("kpi_net").textContent = fmtMoney(netAnnual);
    const covReadout = document.getElementById("cov_readout");
    if(covReadout) covReadout.textContent = `${Math.round(covPct)}%`;

    // Charts: ROI
    if(chartROI) chartROI.destroy();
    chartROI = new Chart(document.getElementById("chart_roi"),{
      type:"bar",
      data:{labels:["Annual benefit","Annual cost","Annual net"], datasets:[{label:"$", data:[grossAnnual, annualCost, netAnnual]}]},
      options:{plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true}}}
    });

    // Monthly trend
    const labels = Array.from({length:months}, (_,i)=>`M${i+1}`);
    const monthlyBenefit = grossAnnual/12;
    const monthlyUnits = unitsAnnual/12;
    const monthlyCost = (startup/months) + fixed + (monthlyUnits*varCost);
    const monthlyNet = monthlyBenefit - monthlyCost;

    const netSeries = labels.map(()=>monthlyNet);
    let cum=0; const cumSeries = netSeries.map(v=>(cum+=v));
    if(chartTrend) chartTrend.destroy();
    chartTrend = new Chart(document.getElementById("chart_trend"),{
      type:"line",
      data:{labels, datasets:[
        {label:"Monthly net", data:netSeries, tension:.25},
        {label:"Cumulative net", data:cumSeries, tension:.25}
      ]},
      options:{plugins:{legend:{labels:{color:"#2f4556"}}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}}}}
    });

    // Break-even chart: vary coverage from 5..60
    const covs = [];
    const nets = [];
    const zeroLine = [];
    const minC = 5, maxC = 60;
    for(let c=minC; c<=maxC; c+=1){
      const eligible = annual * (c/100);
      const baseDis = eligible * baseRate;
      const barDis = baseDis * effBarrierShare;
      const prev = barDis * red;
      const unitsA = prev * unitsPer;
      const grossA = prev * benefitPer;
      const totalCost = startup + fixed*months + (unitsA*(months/12)*varCost);
      const annCost = totalCost*(12/months);
      covs.push(c);
      nets.push(grossA - annCost);
      zeroLine.push(0);
    }

    const ctxBE = document.getElementById("chart_breakeven");
    if(ctxBE){
      if(window.__beChart) window.__beChart.destroy();
      window.__beChart = new Chart(ctxBE, {
        type:"line",
        data:{
          labels: covs.map(x=>`${x}%`),
          datasets:[
            {label:"Annual net impact", data: nets, tension:.25},
            {label:"Break-even ($0)", data: zeroLine, borderDash:[6,6], tension:0}
          ]
        },
        options:{
          plugins:{legend:{labels:{color:"#2f4556"}}},
          scales:{
            x:{ticks:{color:"#2f4556", maxRotation:0, autoSkip:true}, grid:{color:"rgba(11,31,51,.08)"}},
            y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}}
          }
        }
      });
    }

    // Audit memo
    const topOpp = state.selectedOpp || state.opportunities[0] || null;
    const crit = topOpp ? topOpp.criterion : CRA_CRITERIA[activity]?.criterion || "—";
    const memo =
`TIER 3 — TOTAL PROGRAM COST & ROI (Audit-ready)

Selected activity: ${activity}
CRA criterion satisfied: ${crit}

A) Documented transportation disparity (CHNA)
- Transportation overall: ${state.transport.overall==null? "Not detected" : fmtPct(state.transport.overall)}
- Transportation age 65–74: ${state.transport.age6574==null? "Not detected" : fmtPct(state.transport.age6574)}
- Amplification factor: ${(state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall).toFixed(1)+"×" : "—"}

B) Targeting design (this is the partnership lever)
- Targeted coverage of eligible patients: ${Math.round(covPct)}%
- Allocation mode: ${weightMode === "weighted" ? "Senior-weighted (prioritize 65–74)" : "Flat allocation"}
- Seniors share of eligible touchpoints: ${Math.round(senSharePct)}%
- Effective barrier share (after weighting): ${(effBarrierShare*100).toFixed(1)}%

C) Cost baseline (answers: “How much does it cost?”)
- Startup (one-time): ${fmtMoney(startup)}
- Fixed monthly cost: ${fmtMoney(fixed)}
- Variable unit cost: ${fmtMoney(varCost)}
- Units per prevented disruption: ${unitsPer.toFixed(2)}
- Estimated annual units: ${fmtInt(unitsAnnual)}
- Annualized program cost: ${fmtMoney(annualCost)}

D) Impact (annualized)
- Prevented disruptions: ${fmtInt(prevented)}
- Annual gross benefit: ${fmtMoney(grossAnnual)}
- Annual net impact: ${fmtMoney(netAnnual)}

E) Evidence packet
- CHNA excerpt(s) + subgroup differential + page refs
- Target population definition (LMI method) + geography attribution
- Contracts/invoices + service logs + beneficiary counts
- Monitoring cadence with baseline vs observed + corrective actions

Generated: ${new Date().toISOString()}`;
    document.getElementById("audit_out").textContent = memo;

  }

  // ------------------------------
  // Export
  // ------------------------------
  function exportReport(){
    const report = {
      generated_at: new Date().toISOString(),
      docs: state.docs.map(d=>({name:d.name, pages:d.pages, type:d.type})),
      transport: state.transport,
      tier1_findings: state.findings,
      tier2_opportunities: state.opportunities,
      evidence: state.evidence.slice(-100)
    };
    const blob = new Blob([JSON.stringify(report,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "chna_cra_dashboard_report.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ------------------------------
  // Tabs
  // ------------------------------
  function setView(view){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById("view_"+view).classList.add("active");
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.getElementById("tab_"+view).classList.add("active");
  }
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setView(btn.dataset.view));
  });

  // ------------------------------
  // Buttons
  // ------------------------------
  document.getElementById("btn_export").addEventListener("click", exportReport);

  document.getElementById("btn_reset").addEventListener("click", ()=>{
    clearErr();
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};
    document.getElementById("docs_count").textContent="0";
    document.getElementById("ev_count").textContent="0";
    document.getElementById("top_t2").textContent="—";
    document.getElementById("tbl_materiality").innerHTML="";
    document.getElementById("tbl_evidence").innerHTML="";
    document.getElementById("tbl_cra").innerHTML="";
    document.getElementById("audit_out").textContent="";
    if(chartMateriality) chartMateriality.destroy();
    if(chartROI) chartROI.destroy();
    if(chartTrend) chartTrend.destroy();
    renderTransportSpotlight();
    showOk("Reset complete.");
  });

  document.getElementById("btn_demo").addEventListener("click", ()=>{
    clearErr();
    // Demo based on your exact framing: 2.7% overall, 8.5% age 65-74
    const demoText =
      "Why did you not get or delay getting the preventative care you thought you needed? Total: I had transportation problems 2.7%. " +
      "Age 65-74: I had transportation problems 8.5%. " +
      "Of patients surveyed, 7.5% reported food insecurity and 6% reported housing needs. " +
      "Unweighted count 61. Martin County ZIP 56031.";
    state.docs=[{name:"Demo_CHNA.pdf", type:"pdf", pages:1, textByPage:[demoText]}];
    state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};

    scanDoc(state.docs[0]);
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    classifyDocs();
    prefillAlignment();
    scoreAll();
    showOk("Demo loaded (transportation differential).");
  });

  document.getElementById("btn_process").addEventListener("click", async ()=>{
    const log = document.getElementById("proc_log");
    if(log) log.textContent = "";
    const logln = (s)=>{ if(log) log.textContent += s + "
"; };
    clearErr();
    const files = Array.from(document.getElementById("file_input").files || []);
    if(!files.length){
      showErr("No files selected.");
      return;
    }
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};

    for(const f of files){
        logln(`Parsing: ${f.name}`);
      const ext = (f.name.split(".").pop()||"").toLowerCase();
        try {
      let parsed=null;
      try{
        if(ext==="pdf") parsed = await extractPdfText(f);
        else if(ext==="txt") parsed = await extractTxt(f);
        else continue;
        state.docs.push({name:f.name, type:ext, pages:parsed.pages, textByPage:parsed.textByPage});
      }catch(e){
        showErr(`Error parsing ${escapeHtml(f.name)}. Consider uploading a text version if scanned.`);
      }
    }

    // Scan
    for(const d of state.docs){ scanDoc(d); }
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    classifyDocs();
    prefillAlignment();
    scoreAll();
    showOk(`Processed ${state.docs.length} document(s).`);
  });

  document.getElementById("btn_use_top").addEventListener("click", ()=>{
    if(!state.opportunities.length){
      showErr("No Tier 2 opportunities available yet.");
      return;
    }
    state.selectedOpp = state.opportunities[0];
    setTier3FromOpportunity(state.selectedOpp);
    setView("t3");
    showOk("Tier 3 prefilled using top Tier 2 opportunity.");
  });

  document.getElementById("btn_autofill").addEventListener("click", ()=>{
    if(!state.selectedOpp) state.selectedOpp = state.opportunities[0] || null;
    if(state.selectedOpp) setTier3FromOpportunity(state.selectedOpp);
    showOk("Tier 3 auto-fill applied from Tier 2.");
  });

  document.getElementById("btn_run").addEventListener("click", runTier3);
  // Live UI: keep coverage readout updated
  const covEl = document.getElementById("inp_cov");
  const covRead = document.getElementById("cov_readout");
  if(covEl && covRead){
    covRead.textContent = `${covEl.value}%`;
    covEl.addEventListener("input", ()=>{ covRead.textContent = `${covEl.value}%`; });
  }


  // Initial render placeholders
  renderTransportSpotlight();
  document.getElementById("tbl_materiality").innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>Upload documents and click Process Files.</td></tr>";
  document.getElementById("tbl_evidence").innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>—</td></tr>";
  document.getElementById("tbl_cra").innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>—</td></tr>";
  // initialize draft UI
  wireDraftUI();


  // ------------------------------
  // Draft Generator (Application artifacts)
  // ------------------------------
  function pickOpportunity(kind){
    if(!state.opportunities || state.opportunities.length===0) return null;
    if(kind==="auto") return state.opportunities[0];
    return state.opportunities.find(o=>o.kind===kind) || state.opportunities[0];
  }

  function topEvidenceLines(maxLines=4){
    const lines = [];
    // Prefer transportation: show overall + 65–74 if available
    if(state.transport.overall!=null){
      lines.push(`- Transportation barrier overall: ${fmtPct(state.transport.overall)} (source: ${findEvidenceRef("Transportation barrier", "Overall") || "see evidence table"})`);
    }
    if(state.transport.age6574!=null){
      lines.push(`- Transportation barrier age 65–74: ${fmtPct(state.transport.age6574)} (source: ${findEvidenceRef("Transportation barrier", "Age 65") || "see evidence table"})`);
    }
    const others = state.findings.filter(f=>f.key!=="transport").slice(0, maxLines);
    for(const f of others){
      lines.push(`- ${f.disparity} (${f.segment}): ${fmtPct(f.magnitude)} (evidence: ${f.evidenceRef||"—"})`);
    }
    return lines.join("\n");
  }

  function findEvidenceRef(disparityLabel, segmentHint){
    const f = state.findings.find(x => x.disparity === disparityLabel && (!segmentHint || x.segment.includes(segmentHint)));
    return f ? f.evidenceRef : null;
  }

  function appPacketChecklist(kind){
    const common = [
      "CHNA excerpt(s) with page references (documented need + affected segment)",
      "Target population definition (LMI method and/or qualifying segment definition)",
      "Geographic attribution method (AA mapping via ZIP/tract/county; proportional benefit if broader)",
      "Contracts/MOUs/service agreements and invoices (clean audit trail)",
      "Service logs and beneficiary counts (units delivered; counts served; LMI estimate)",
      "Monitoring cadence (baseline vs observed; variance notes; corrective actions)"
    ];
    const nmt = [
      "Ride logs (date/time pickup/dropoff; appointment type; beneficiary ZIP)",
      "Broker/vendor KPIs (on-time rate, completed rides, cancellations, no-shows)",
      "Eligibility gating rationale (senior prioritization supported by CHNA differential)"
    ];
    const food = [
      "Distribution logs (units delivered; eligibility; geography)",
      "Partner controls (stock, delivery cadence, audit spot-checks)"
    ];
    const care = [
      "Workflow documentation (referral pathways; intake criteria)",
      "Referral counts and closed-loop outcomes"
    ];
    let extra = [];
    if(kind==="nmt") extra = nmt;
    if(kind==="food") extra = food;
    if(kind==="care") extra = care;
    return common.concat(extra).map(x=>`- ${x}`).join("\n");
  }

  function renderCrosswalkTable(opportunity){
    const rows = state.opportunities.map(o => {
      return `| ${o.opp} | ${o.tests} | ${o.criterion} | ${o.score} (${o.strength}) | ${o.scope} |`;
    });
    return [
      "| Opportunity | CRA test mapping | Criterion satisfied | Readiness | Scope guidance |",
      "|---|---|---|---|---|",
      ...rows
    ].join("\n");
  }

  function draftHeader(tone, projectName){
    const title = projectName ? projectName : "CRA‑Aligned Health Access Initiative";
    const toneLine = tone==="bank" ? "Bank CRA File Draft" : (tone==="hospital" ? "Hospital Internal Approval Draft" : "Joint Bank–Hospital Draft");
    return `${title}\n${toneLine}\nGenerated: ${new Date().toISOString()}\n`;
  }

  function generateDraft(draftType, oppKind, tone){
    const opp = pickOpportunity(oppKind);
    const projectName = (document.getElementById("draft_project_name")?.value || "").trim();
    const partner = (document.getElementById("draft_partner")?.value || "").trim();
    const scopeNote = (document.getElementById("draft_scope_note")?.value || "").trim();
    const structure = (document.getElementById("draft_structure")?.value || "").trim();

    const header = draftHeader(tone, projectName);
    const oppLine = opp ? `${opp.opp}\nCRA criterion satisfied: ${opp.criterion}\nCRA test mapping: ${opp.tests}\nReadiness: ${opp.score} (${opp.strength})\n` :
      "No Tier 2 opportunities available yet. Process documents first.\n";

    const evidence = topEvidenceLines(4);

    // Tier 3 model inclusion when available
    let modelBlock = "Tier 3 (cost & ROI): Not yet run. Run Tier 3 to populate cost baseline and break‑even assumptions.\n";
    if(state.model){
      modelBlock =
`Tier 3 (cost & ROI) — most recent scenario:
- Activity: ${state.model.activity}
- Coverage: ${state.model.coverage_pct}% (${state.model.weight_mode === "weighted" ? "senior‑weighted" : "flat"}; seniors share ${state.model.seniors_share_pct}%)
- Annualized program cost: ${fmtMoney(state.model.annual_cost)}
- Annual gross benefit: ${fmtMoney(state.model.gross_annual_benefit)}
- Annual net impact: ${fmtMoney(state.model.net_annual)}
- Assumptions: baseline disruption ${state.model.baseline_rate_pct.toFixed(1)}%, barrier share ${state.model.barrier_share_pct.toFixed(1)}%, reduction ${state.model.reduction_pct.toFixed(1)}%.\n`;
    }

    const orgLines = [
      partner ? `Implementing partner: ${partner}` : null,
      structure ? `Funding structure: ${structure}` : null,
      scopeNote ? `AA/scope note: ${scopeNote}` : null
    ].filter(Boolean).join("\n");

    if(draftType==="cra_memo"){
      return `${header}
1) Selected opportunity
${oppLine}
${orgLines ? orgLines + "\n" : ""}

2) Performance context and documented need (CHNA evidence)
${evidence}

3) Why this is responsive (what changes)
- The activity is targeted to the population segment(s) with the largest documented access disruption (e.g., seniors where transportation barrier is amplified).
- The implementation design includes traceable eligibility, service logs, and geography attribution to support exam defensibility.

4) Eligibility criterion satisfied (explicit)
${opp ? opp.criterion : "—"}

5) Scope and attribution
- Primary: attribute benefit within the bank’s assessment area by documenting beneficiary location (ZIP/tract/county) and delivery footprint.
- Secondary: if broader, document proportional benefit allocation and retain mapping evidence.

6) Program cost baseline and impact (decision support)
${modelBlock}

7) Evidence & monitoring packet (minimum)
${appPacketChecklist(opp ? opp.kind : "nmt")}
`;
    }

    if(draftType==="exam_narrative"){
      const amp = (state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall) : null;
      const ampLine = amp ? `Transportation barriers were amplified among older adults (~${amp.toFixed(1)}× vs overall), supporting a targeted access response.` : `Transportation barriers were documented in the CHNA and used to target the activity.`;
      return `${header}
Examiner‑facing narrative (Performance Evaluation style)

The institution supported a community services initiative aligned to documented local needs. ${ampLine}
The activity was structured to meet the CRA qualifying criterion as a community development service targeted to low‑ or moderate‑income individuals (criterion and support documentation retained). The institution maintained an audit trail including service logs, invoices, and beneficiary counts, and tracked outcomes against a defined baseline.

Evidence basis (CHNA excerpts):
${evidence}

CRA criterion satisfied:
${opp ? opp.criterion : "—"}

${state.model ? "Quantified program cost and impact (annualized):\n- Cost: "+fmtMoney(state.model.annual_cost)+"\n- Net impact: "+fmtMoney(state.model.net_annual)+"\n" : ""}`;
    }

    if(draftType==="crosswalk"){
      return `${header}
CRA Eligibility Crosswalk (working)

${renderCrosswalkTable(opp)}
`;
    }

    if(draftType==="term_sheet"){
      return `${header}
Joint Partnership Term Sheet (working draft)

Project: ${projectName || (opp ? opp.opp : "—")}
Purpose: Address documented access disparities through a targeted intervention aligned with CRA community development criteria.

Parties:
- Hospital: _______________________
- Bank: ___________________________
${partner ? "- Implementing partner: "+partner+"\n" : ""}

Need statement (CHNA):
${evidence}

CRA criterion satisfied:
${opp ? opp.criterion : "—"}

Geographic attribution:
- Assessment area targeting: document beneficiary location and service footprint.
${scopeNote ? "- Notes: "+scopeNote+"\n" : ""}

Funding structure:
${structure || "TBD (grant / investment / service agreement — choose the structure that best aligns with bank CRA strategy and hospital operations)."}

Budget baseline (annualized):
${state.model ? "- Program cost: "+fmtMoney(state.model.annual_cost)+"\n- Expected net impact: "+fmtMoney(state.model.net_annual)+"\n" : "- Run Tier 3 to populate cost baseline and scenario.\n"}

Evidence & reporting:
${appPacketChecklist(opp ? opp.kind : "nmt")}

Sign‑off workflow:
- Hospital approval: ____________________
- Bank CRA approval: ___________________
`;
    }

    if(draftType==="chna_brief"){
      return `${header}
CHNA Implementation Alignment Brief

CHNA‑documented need:
${evidence}

Selected intervention:
${oppLine}

Implementation summary:
- Target segment(s): older adults prioritized when transportation barriers are amplified; additional eligibility defined by LMI method and service area.
- Delivery model: partner/brokered NEMT with documented ride logs and monitoring.

Budget and evaluation:
${modelBlock}

KPIs:
- Completed rides
- Prevented disruptions (missed appointments)
- Beneficiary counts and geography attribution
- Monthly monitoring with corrective action triggers
`;
    }

    if(draftType==="monitor_plan"){
      return `${header}
Monitoring & Evidence Plan (Exam‑ready)

Selected opportunity:
${oppLine}

Data capture (minimum):
${appPacketChecklist(opp ? opp.kind : "nmt")}

Monitoring cadence:
- Weekly: operational exceptions (cancellations, no‑shows, delayed pickups)
- Monthly: units delivered; beneficiary counts; geography attribution spot check; budget variance
- Quarterly: baseline vs observed disruption rate; program adjustments and corrective actions

Outputs:
- Audit trail pack (contracts/invoices/service logs)
- Quarterly narrative of responsiveness and observed performance
`;
    }


    if(draftType==="pnl"){
      const m = state.model?.outputs;
      if(!m) return `${header}\nP&L Draft unavailable: Run Tier 3 ROI first.\n`;
      const baseNet = m.net_benefit;
      const coding = state.model?.coding?.uplift || 0;
      const totalNet = state.model?.totalNet ?? (baseNet + coding);

      return `${header}
Borrower P&L Statement (Hospital) — Annualized (Draft)

Revenue & Contribution:
- Gross revenue recaptured: ${fmtMoney(m.gross_rev)}
- Less: Marginal clinical cost: ${fmtMoney(m.marginal_cost)}
= Contribution margin from recovered visits: ${fmtMoney(m.gross_rev - m.marginal_cost)}

Program Costs:
- Transportation direct cost: ${fmtMoney(m.transport_cost)}
- Program overhead cost: ${fmtMoney(m.overhead_cost)}
= Total program cost: ${fmtMoney(m.total_program_cost)}

Net Operating Result (Base, Excel parity):
- Net annual benefit: ${fmtMoney(baseNet)}

Optional Coding Layer (if enabled):
- Coding uplift: ${fmtMoney(coding)}
- Net incl. coding uplift: ${fmtMoney(totalNet)}

Notes:
- Base ROI follows Excel-parity incremental margin model.
- Coding uplift is optional and should be supported by documentation workflows and coding governance.
`;
    }

    if(draftType==="proforma_3yr"){
      const m = state.model?.outputs;
      if(!m) return `${header}\n3-Year Pro Forma unavailable: Run Tier 3 ROI first.\n`;

      // simple conservative pro forma: allow growth & inflation assumptions (defaults)
      const growth = parseFloat((document.getElementById("draft_growth")?.value || "5"))/100;
      const infl = parseFloat((document.getElementById("draft_infl")?.value || "3"))/100;

      const y1_rev = m.gross_rev;
      const y1_marg = m.marginal_cost;
      const y1_cost = m.total_program_cost;
      const y1_net = m.net_benefit;

      const rows = [];
      for(let yr=1; yr<=3; yr++){
        const factor = Math.pow(1+growth, yr-1);
        const costFactor = Math.pow(1+infl, yr-1);
        const rev = y1_rev * factor;
        const marg = y1_marg * factor;
        const prog = y1_cost * costFactor;
        const net = rev - marg - prog;
        rows.push({yr, rev, marg, prog, net});
      }

      const table = rows.map(r=>`Year ${r.yr}: Revenue ${fmtMoney(r.rev)} | Marginal cost ${fmtMoney(r.marg)} | Program cost ${fmtMoney(r.prog)} | Net ${fmtMoney(r.net)}`).join("\n");

      return `${header}
Project Pro Forma Budget (3-Year) — Draft

Assumptions:
- Volume/revenue growth on recovered visits: ${(growth*100).toFixed(1)}% / year
- Program cost inflation: ${(infl*100).toFixed(1)}% / year
- Base Year 1 values derived from Tier 3 ROI (Excel parity)

3-Year Summary:
${table}

Interpretation:
- Year 1 is the conservative base case (spreadsheet parity).
- Growth reflects program maturation and improved engagement.
- Inflation reflects vendor and admin cost escalation.
`;
    }

    // fallback
    return `${header}\nNo draft type selected.\n`;
  }

  function wireDraftUI(){
    const genBtn = document.getElementById("btn_generate_draft");
    if(!genBtn) return; // view not present
    genBtn.addEventListener("click", ()=>{
      const type = document.getElementById("draft_type").value;
      const kind = document.getElementById("draft_activity").value;
      const tone = document.getElementById("draft_tone").value;
      const txt = generateDraft(type, kind, tone);
      document.getElementById("draft_preview").textContent = txt;
    });

    document.getElementById("btn_copy_draft").addEventListener("click", async ()=>{
      const txt = document.getElementById("draft_preview").textContent || "";
      try{
        await navigator.clipboard.writeText(txt);
        showOk("Draft copied to clipboard.");
      }catch(e){
        showOk("Copy failed in this browser. You can manually select the text and copy.");
      }
    });

    document.getElementById("btn_download_draft").addEventListener("click", ()=>{
      const txt = document.getElementById("draft_preview").textContent || "";
      const blob = new Blob([txt], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const type = document.getElementById("draft_type").value;
      a.download = `cra_application_${type}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }


  function _num(id){
    const el = document.getElementById(id);
    if(!el) return 0;
    let v = parseFloat(el.value);
    if(isNaN(v)) return 0;
    return (v > 1) ? v/100 : v; // normalize percent-style
  }

  function render_roi(){
    try{
      const visits = parseFloat(document.getElementById("a_visits").value);
      const noshow = _num("a_noshow");
      const share = _num("a_share");
      const netrev = parseFloat(document.getElementById("a_netrev").value);
      const margc = parseFloat(document.getElementById("a_margc").value);
      const mitig = _num("b_mitig");
      const trip = parseFloat(document.getElementById("b_trip").value);
      const over = _num("b_over");

      const transport_no_shows = visits * noshow * share;
      const prevented = transport_no_shows * mitig;
      const gross_rev = prevented * netrev;
      const marginal_cost = prevented * margc;
      const transport_cost = prevented * trip;
      const overhead_cost = transport_cost * over;
      const total_cost = transport_cost + overhead_cost;
      const net = gross_rev - marginal_cost - total_cost;
      const roi = total_cost === 0 ? 0 : net/total_cost;
      const be_trip = netrev - margc;

      document.getElementById("o_net").textContent = "$" + net.toLocaleString();
      document.getElementById("o_cost").textContent = "$" + total_cost.toLocaleString();
      document.getElementById("o_roi").textContent = roi.toFixed(2) + "x";
      document.getElementById("o_tripmax").textContent = "$" + be_trip.toFixed(0);

      const ctx = document.getElementById("roi_bar");
      if(ctx){
        new Chart(ctx, {
          type:"bar",
          data:{
            labels:["Gross Revenue","Marginal Cost","Program Cost","Net Benefit"],
            datasets:[{data:[gross_rev,marginal_cost,total_cost,net]}]
          },
          options:{plugins:{legend:{display:false}}}
        });
      }

    }catch(e){
      console.error(e);
      alert("ROI error: " + e.message);
    }
  }


  function _normRate(x){
    // Accept decimals (0.2) or percents (20)
    if(isNaN(x)) return 0;
    return (x > 1) ? (x/100) : x;
  }

  function roi_inputs(){
    const visits = parseFloat(document.getElementById("a_visits").value) || 0;
    return {
      visits,
      noshow: _normRate(parseFloat(document.getElementById("a_noshow").value)),
      share: _normRate(parseFloat(document.getElementById("a_share").value)),
      netrev: parseFloat(document.getElementById("a_netrev").value) || 0,
      margc: parseFloat(document.getElementById("a_margc").value) || 0,
      mitig: _normRate(parseFloat(document.getElementById("b_mitig").value)),
      trip: parseFloat(document.getElementById("b_trip").value) || 0,
      over: _normRate(parseFloat(document.getElementById("b_over").value)),
      lmi: _normRate(parseFloat(document.getElementById("c_lmi").value)),
      aa: _normRate(parseFloat(document.getElementById("c_aa").value)),
      bank: parseFloat(document.getElementById("c_bank").value) || 0
    };
  }

  function roi_calc(inp){
    const transport_no_shows = inp.visits * inp.noshow * inp.share;
    const prevented = transport_no_shows * inp.mitig;
    const gross_rev = prevented * inp.netrev;
    const marginal_cost = prevented * inp.margc;
    const transport_cost = prevented * inp.trip;
    const overhead_cost = transport_cost * inp.over;
    const total_program_cost = transport_cost + overhead_cost;
    const net_benefit = gross_rev - marginal_cost - total_program_cost;
    const be_trip_max = inp.netrev - inp.margc;

    const trips = prevented;
    const lmi_trips = trips * inp.lmi;
    const aa_trips = trips * inp.aa;
    const bank_per_lmi = (lmi_trips===0) ? 0 : (inp.bank/lmi_trips);
    const bank_share_cost = (total_program_cost===0) ? 0 : (inp.bank/total_program_cost);

    const narrative = `Estimated ${Math.round(lmi_trips).toLocaleString()} LMI trips and ${Math.round(trips).toLocaleString()} essential visits enabled annually within the Assessment Area.`;
    return {transport_no_shows, prevented, gross_rev, marginal_cost, transport_cost, overhead_cost, total_program_cost, net_benefit, be_trip_max,
            trips, lmi_trips, aa_trips, bank_per_lmi, bank_share_cost, narrative};
  }

  function coding_uplift(preventedVisits, allVisits){
    const enabled = document.getElementById("toggle_coding").checked;
    if(!enabled) return {uplift:0, detail:"Coding layer not enabled."};

    const zRate = _normRate(parseFloat(document.getElementById("z_rate").value));
    const zUplift = parseFloat(document.getElementById("z_uplift").value) || 0;
    const cptRate = _normRate(parseFloat(document.getElementById("cpt_rate").value));
    const cptUplift = parseFloat(document.getElementById("cpt_uplift").value) || 0;
    const base = document.getElementById("coding_base").value; // prevented | all
    const n = (base === "all") ? allVisits : preventedVisits;

    const zAdd = n * zRate * zUplift;
    const cptAdd = n * cptRate * cptUplift;
    const uplift = zAdd + cptAdd;

    const notes = (document.getElementById("coding_notes").value || "").trim();
    const detail = `Coding uplift applied to ${base === "all" ? "all targeted visits" : "recovered visits"}:
- Z-code capture: ${(zRate*100).toFixed(1)}% × $${zUplift.toFixed(0)} = $${zAdd.toFixed(0)}
- CPT capture: ${(cptRate*100).toFixed(1)}% × $${cptUplift.toFixed(0)} = $${cptAdd.toFixed(0)}
${notes ? "- Notes: " + notes : ""}`.trim();

    return {uplift, detail};
  }

  function render_roi(){
    const inp = roi_inputs();
    const out = roi_calc(inp);

    // Base KPI outputs (Excel parity)
    document.getElementById("o_net").textContent = "$" + out.net_benefit.toLocaleString(undefined,{maximumFractionDigits:0});
    document.getElementById("o_tripmax").textContent = "$" + out.be_trip_max.toFixed(0);

    // Coding uplift (optional)
    const cu = coding_uplift(out.prevented, inp.visits);
    document.getElementById("o_code").textContent = "$" + cu.uplift.toLocaleString(undefined,{maximumFractionDigits:0});

    const totalNet = out.net_benefit + cu.uplift;
    document.getElementById("o_total_net").textContent = "$" + totalNet.toLocaleString(undefined,{maximumFractionDigits:0});

    const roiTotal = (out.total_program_cost===0) ? 0 : (totalNet / out.total_program_cost);
    document.getElementById("o_roi").textContent = (out.total_program_cost===0) ? "—" : roiTotal.toFixed(2) + "x";

    // Chart
    const ctx = document.getElementById("roi_bar");
    if(ctx){
      new Chart(ctx, {
        type:"bar",
        data:{
          labels:["Gross revenue recaptured","Marginal clinical cost","Total program cost","Base net benefit","Coding uplift","Net incl. coding"],
          datasets:[{data:[out.gross_rev,out.marginal_cost,out.total_program_cost,out.net_benefit,cu.uplift,totalNet]}]
        },
        options:{plugins:{legend:{display:false}}}
      });
    }

    // CRA outputs (unchanged)
    const craTxt =
`Trips delivered (round trips): ${Math.round(out.trips).toLocaleString()}
LMI trips: ${Math.round(out.lmi_trips).toLocaleString()}
AA trips: ${Math.round(out.aa_trips).toLocaleString()}

Bank annual contribution: $${inp.bank.toLocaleString()}
Bank contribution per LMI trip: $${out.bank_per_lmi.toFixed(0)}
Share of total program cost funded by Bank: ${(out.bank_share_cost*100).toFixed(1)}%

Narrative-ready summary:
${out.narrative}`;
    document.getElementById("cra_box").textContent = craTxt;

    // Audit memo
    document.getElementById("roi_audit").textContent =
`Tier 3 — Excel-parity ROI + Coding ROI Layer

Base ROI (Excel parity):
- Net benefit: $${out.net_benefit.toFixed(0)}
- Total program cost: $${out.total_program_cost.toFixed(0)}
- Break-even trip cost max: $${out.be_trip_max.toFixed(0)}

Coding ROI Layer:
${cu.detail}

Total net (incl. coding): $${totalNet.toFixed(0)}
ROI incl. coding: ${out.total_program_cost===0 ? "—" : roiTotal.toFixed(2)+"x"}

Generated: ${new Date().toISOString()}`;

    // persist for draft generator
    state.model = { roi_parity:true, inputs: inp, outputs: out, coding: cu, totalNet, roiTotal };
  }


  (function(){
    const t = document.getElementById("toggle_coding");
    const box = document.getElementById("coding_box");
    if(t && box){
      t.addEventListener("change", ()=>{ box.style.display = t.checked ? "block" : "none"; });
    }
  })();


  // ------------------------------
  // Tier 3 Coding layer UX: recompute on toggle/input changes
  // ------------------------------
  (function(){
    const t = document.getElementById("toggle_coding");
    const box = document.getElementById("coding_box");
    if(t && box){
      const sync = ()=>{ box.style.display = t.checked ? "block" : "none"; };
      sync();
      t.addEventListener("change", ()=>{ sync(); if(typeof render_roi === "function") render_roi(); });
      ["z_rate","z_uplift","cpt_rate","cpt_uplift","coding_base"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener("change", ()=>{ if(typeof render_roi === "function") render_roi(); });
        if(el) el.addEventListener("input", ()=>{ if(typeof render_roi === "function") render_roi(); });
      });
    }
  })();

  // ------------------------------
  // Tier 4-6 generators (prototype content)
  // ------------------------------
  window.copy_block = async function(id){
    const el = document.getElementById(id);
    if(!el) return;
    const txt = el.textContent || "";
    try{ await navigator.clipboard.writeText(txt); showOk("Copied."); }catch(e){ showOk("Copy not available; select text manually."); }
  };

  window.generate_impl_plan = function(){
    const opp = state.opportunities?.[0];
    const m = state.model?.outputs;
    const txt =
`Implementation Plan (30-60-90)

Selected opportunity: ${opp ? opp.opp : "—"}
CRA criterion satisfied: ${opp ? opp.criterion : "—"}

0–30 days
- Confirm target geography and eligible population (LMI method) and document AA attribution.
- Finalize partner/vendor and service workflow (scheduling, eligibility, ride confirmation, documentation).
- Build the evidence packet template (contracts, invoices, ride logs, beneficiary counts).

31–60 days
- Launch pilot; begin weekly operational monitoring.
- Collect ride logs, completed visits enabled, cancellations/no-shows, and beneficiary ZIP/tract.
- Produce first monthly report: volumes, costs, and exceptions.

61–90 days
- Compare baseline vs observed: transport-related no-shows prevented.
- Adjust workflow; document corrective actions.
- Produce quarterly outcomes report for CRA file and hospital leadership.

${m ? "\nCurrent ROI baseline:\n- Prevented no-shows: "+Math.round(m.prevented).toLocaleString()+"\n- Net benefit: "+fmtMoney(m.net_benefit) : ""}`;
    document.getElementById("impl_plan").textContent = txt;
  };

  window.generate_outcomes_report = function(){
    const opp = state.opportunities?.[0];
    const m = state.model?.outputs;
    const txt =
`Quarterly Outcomes Report Template

Project: ${opp ? opp.opp : "—"}
Reporting period: ___________________

Operational Outputs
- Trips delivered (round trips): ${m ? Math.round(m.trips).toLocaleString() : "—"}
- Completed visits enabled: ${m ? Math.round(m.prevented).toLocaleString() : "—"}
- Cancellation rate: _______
- On-time pickup rate: _______

Beneficiary & Scope (CRA)
- % LMI: _______   (method: _______)
- LMI trips: ${m ? Math.round(m.lmi_trips).toLocaleString() : "—"}
- % within AA: _______
- AA trips: ${m ? Math.round(m.aa_trips).toLocaleString() : "—"}

Financial (Hospital)
- Gross revenue recaptured: ${m ? fmtMoney(m.gross_rev) : "—"}
- Total program cost: ${m ? fmtMoney(m.total_program_cost) : "—"}
- Net annual benefit (base): ${m ? fmtMoney(m.net_benefit) : "—"}

Narrative
- Describe responsiveness to documented CHNA need and any adjustments made.
`;
    document.getElementById("outcomes_report").textContent = txt;
  };

  window.generate_eval_plan = function(){
    const opp = state.opportunities?.[0];
    const txt =
`Evaluation Plan Template

1) Purpose
Evaluate whether the intervention reduces transport-related missed appointments and improves access for the target population.

2) Baseline
- Baseline no-show rate (overall): _______
- Transport-attributable no-show share: _______
- CHNA evidence citations: ${state.findings?.slice(0,3).map(f=>f.evidenceRef).filter(Boolean).join("; ") || "—"}

3) Design
- Pre/post comparison (baseline period vs intervention period)
- Stratify by: age group (65–74), LMI status, and geography (AA)

4) Metrics
- Primary: prevented no-shows, trips delivered, completed visits enabled
- Secondary: downstream utilization proxies (optional), patient experience, timeliness
- CRA: LMI trips, AA trips, bank $/LMI trip

5) Data sources
- Scheduling system, ride logs, billing/RVUs, SDOH screening/Z-codes (if enabled)

6) Governance & cadence
- Weekly ops huddle, monthly reporting, quarterly executive review
- Corrective action triggers: missed pickup rate, high cancellations, documentation gaps

7) Deliverables
- Quarterly outcomes report
- Year-end evaluation report with lessons learned and scaling recommendation
`;
    document.getElementById("eval_plan").textContent = txt;
  };


// ===== Tier 1 Enhanced Scoring (40/20/40) =====
const ALIGN_ITEMS = [
  {id:"prio_continuity", item:"Priority continuity (CHNA priorities appear in CHIP priorities)"},
  {id:"action_specific", item:"Action specificity (measurable strategies/objectives exist)"},
  {id:"ownership", item:"Governance/ownership (responsible entities identified)"},
  {id:"monitoring", item:"Monitoring cadence (quarterly/annual monitoring described)"},
  {id:"resources_sig", item:"Resource signals (funding/partners/resources referenced)"},
  {id:"sdoh_oper", item:"SDOH/transport operationalization (transport barriers → strategies/actions)"}
];

function buildAlignTable(){
  const tbl = document.getElementById("tbl_align");
  if(!tbl) return;
  let h = "<tr><th>Item</th><th>Score (0–2)</th><th>Evidence</th></tr>";
  for(const it of ALIGN_ITEMS){
    h += `<tr><td><b>${it.item}</b></td>
      <td><select data-align="${it.id}"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select></td>
      <td><textarea data-align-e="${it.id}" placeholder="Evidence reference"></textarea></td></tr>`;
  }
  tbl.innerHTML = h;
}

function classifyDocs(){
  const chnaSel = document.getElementById("sel_chna");
  const chipSel = document.getElementById("sel_chip");
  if(!chnaSel || !chipSel) return;
  chnaSel.innerHTML=""; chipSel.innerHTML="";
  if(!state.docs || state.docs.length===0){
    chnaSel.innerHTML="<option value=''> (no uploads) </option>";
    chipSel.innerHTML="<option value=''> (no uploads) </option>";
    return;
  }
  for(const d of state.docs){
    const o1=document.createElement("option"); o1.value=d.name; o1.textContent=d.name; chnaSel.appendChild(o1);
    const o2=document.createElement("option"); o2.value=d.name; o2.textContent=d.name; chipSel.appendChild(o2);
  }
  const lower = (d)=>d.textByPage.join(" ").toLowerCase();
  const chna = state.docs.find(d=>lower(d).includes("community health needs assessment") || lower(d).includes("chna")) || state.docs[0];
  const chip = state.docs.find(d=>lower(d).includes("community health improvement plan") || lower(d).includes("chip")) || (state.docs.length>1 ? state.docs[1] : state.docs[0]);
  chnaSel.value = chna.name;
  chipSel.value = chip.name;
  if(chnaSel.value===chipSel.value && state.docs.length>1) chipSel.value = state.docs[1].name;
}

function getDocText(name){
  const d = state.docs.find(x=>x.name===name);
  return d ? d.textByPage.join("\n") : "";
}

function extractCHNAPriorities(text){
  const m = text.match(/These top three health priorities are:[\s\S]{0,260}/i);
  if(m){
    const seg = m[0];
    const lines = seg.split(/\n|\r/).map(x=>x.trim()).filter(Boolean);
    const pr=[];
    for(const ln of lines){
      const mm = ln.match(/^\s*\d\s+(.+)$/);
      if(mm) pr.push(mm[1].trim());
    }
    if(pr.length) return pr.slice(0,3);
  }
  const keys=["Mental Health","Access to Care","Basic Needs","Substance Use","Chronic Disease","Maternal"];
  const lower=text.toLowerCase();
  const pr=[];
  for(const k of keys){ if(lower.includes(k.toLowerCase())) pr.push(k); if(pr.length>=3) break; }
  return pr;
}

function extractCHIPPriorities(text){
  const pr=[];
  const re=/Priority Health Issue:\s*([^\n\r]+)/gi;
  let m;
  while((m=re.exec(text))!==null){
    const p=m[1].trim();
    if(p && !pr.includes(p)) pr.push(p);
    if(pr.length>=8) break;
  }
  if(pr.length) return pr;
  const keys=["Adverse Childhood Experiences","Mental Health","Substance Abuse","Chronic Disease","Access to Care"];
  const lower=text.toLowerCase();
  for(const k of keys){ if(lower.includes(k.toLowerCase())) pr.push(k); }
  return pr;
}

function prefillAlignment(){
  const chnaName=document.getElementById("sel_chna")?.value || "";
  const chipName=document.getElementById("sel_chip")?.value || "";
  if(!chnaName || !chipName){ showOk("Upload CHNA and CHIP PDFs to prefill alignment."); return; }
  const chnaText=getDocText(chnaName);
  const chipText=getDocText(chipName);
  const chnaP=extractCHNAPriorities(chnaText);
  const chipP=extractCHIPPriorities(chipText);
  const box=document.getElementById("prio_box");
  if(box){
    box.textContent = `CHNA priorities (${chnaName}):\n- ${chnaP.join("\n- ") || "(not detected)"}\n\nCHIP priorities (${chipName}):\n- ${chipP.join("\n- ") || "(not detected)"}`;
  }
  const overlap = chnaP.filter(x=>chipP.some(y=>y.toLowerCase().includes(x.toLowerCase()) || x.toLowerCase().includes(y.toLowerCase())));
  const continuity = overlap.length>=2 ? 2 : (overlap.length===1 ? 1 : 0);
  const chipLower=chipText.toLowerCase();
  const set=(id,score,note)=>{
    const sel=document.querySelector(`select[data-align='${id}']`);
    const ta=document.querySelector(`textarea[data-align-e='${id}']`);
    if(sel) sel.value=String(score);
    if(ta && !ta.value) ta.value=note;
  };
  set("prio_continuity", continuity, `Auto overlap: ${overlap.join(", ") || "none"}`);
  set("action_specific", (chipLower.includes("action plan") && (chipLower.includes("outcome objective") || chipLower.includes("key activities"))) ? 2 : (chipLower.includes("strategy") ? 1 : 0), "Auto: action plan/strategy language");
  set("ownership", (chipLower.includes("who is responsible") || chipLower.includes("community partners")) ? 2 : (chipLower.includes("coalition") ? 1 : 0), "Auto: governance/ownership language");
  set("monitoring", (chipLower.includes("monitor") && (chipLower.includes("quarter") || chipLower.includes("annually"))) ? 2 : (chipLower.includes("monitor") ? 1 : 0), "Auto: monitoring cadence language");
  set("resources_sig", (chipLower.includes("funding") || chipLower.includes("resource")) ? 2 : (chipLower.includes("partner") ? 1 : 0), "Auto: resource signals");
  set("sdoh_oper", (chipLower.includes("transport") && (chipLower.includes("contract") || chipLower.includes("agreement") || chipLower.includes("assessment"))) ? 2 : (chipLower.includes("transport") ? 1 : 0), "Auto: transport operationalization");
  showOk("Alignment prefill complete (verify/adjust).");
  scoreAll();
}

function scoreStructural(){
  let total=0, max=0;
  for(const it of RUBRIC_ITEMS){
    if(it.id.startsWith("wc_")) continue;
    const sel=document.querySelector(`select[data-rubric='${it.id}']`);
    total += sel ? parseInt(sel.value,10) : 0;
    max += 2;
  }
  return {pct: max? Math.round((total/max)*100):0};
}

function scoreInput(){
  const ids=["wc_solicited","wc_received","wc_used"];
  let total=0; const max=ids.length*2;
  for(const id of ids){
    const sel=document.querySelector(`select[data-rubric='${id}']`);
    total += sel ? parseInt(sel.value,10) : 0;
  }
  const compliant = ids.every(id=>{
    const sel=document.querySelector(`select[data-rubric='${id}']`);
    return sel && parseInt(sel.value,10)===2;
  });
  return {pct: max? Math.round((total/max)*100):0, compliant};
}

function scoreAlign(){
  let total=0; const max=ALIGN_ITEMS.length*2;
  for(const it of ALIGN_ITEMS){
    const sel=document.querySelector(`select[data-align='${it.id}']`);
    total += sel ? parseInt(sel.value,10) : 0;
  }
  return {pct: max? Math.round((total/max)*100):0};
}

function scoreAll(){
  const s=scoreStructural();
  const i=scoreInput();
  const a=scoreAlign();
  const iri=Math.round(0.40*s.pct + 0.20*i.pct + 0.40*a.pct);
  const elS=document.getElementById("kpi_struct"); if(elS) elS.textContent=s.pct+"%";
  const elI=document.getElementById("kpi_input"); if(elI) elI.textContent=i.compliant ? "Compliant" : (i.pct+"%");
  const elA=document.getElementById("kpi_align"); if(elA) elA.textContent=a.pct+"%";
  const elR=document.getElementById("kpi_iri"); if(elR) elR.textContent=iri+"%";

  const unlocked = (s.pct>=55 && iri>=55);
  const dot=document.getElementById("gateDot");
  if(dot){
    dot.classList.remove("good","bad");
    dot.classList.add(unlocked ? "good" : "bad");
  }
  const gt=document.getElementById("gateText");
  if(gt) gt.textContent = unlocked ? "Downstream tiers unlocked (IRI ≥ 55%, structural ≥ 55%)" : "Improve Tier 1 scores to unlock downstream tiers";
  return {s,i,a,iri};
}

// Ensure alignment table exists
document.addEventListener("DOMContentLoaded", ()=>{ try{ buildAlignTable(); }catch(e){} });


  // ------------------------------
  // Tier 2 CRA Rule Engine (embedded logic)
  // ------------------------------
  state.cra = { score:null };

  function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; }

  function runCRAEngine(){
    // Inputs
    const lmi = parseInt(document.getElementById("cra_lmi").value, 10) || 0;
    const aa  = parseInt(document.getElementById("cra_aa").value, 10) || 0;
    const primary = parseInt(document.getElementById("cra_primary").value, 10) || 0;
    const resp = parseInt(document.getElementById("cra_resp").value, 10) || 0;
    const complex = parseInt(document.getElementById("cra_complex").value, 10) || 0;
    const lead = parseInt(document.getElementById("cra_lead").value, 10) || 0;
    const activity = document.getElementById("cra_activity").value;
    const structure = document.getElementById("cra_structure").value;

    // Documentation readiness (% checked)
    const docs = Array.from(document.querySelectorAll(".cra_doc"));
    const checked = docs.filter(x=>x.checked).length;
    const docsPct = docs.length ? Math.round((checked/docs.length)*100) : 0;

    // Eligibility score (0–100): primary purpose (40), LMI targeting (30), AA attribution (30)
    const elig = Math.round((primary/2)*40 + (lmi/100)*30 + (aa/100)*30);

    // Defensibility score (0–100): responsiveness (35), complexity (25), leadership (20), measurability (20 via docsPct)
    const def = Math.round((resp/2)*35 + (complex/2)*25 + (lead/2)*20 + (docsPct/100)*20);

    // Docs readiness (0–100) directly
    const docScore = docsPct;

    // Total Tier 2 score: weighted (elig 45%, def 35%, docs 20%)
    const total = Math.round(0.45*elig + 0.35*def + 0.20*docScore);

    setText("cra_elig", elig + "%");
    setText("cra_def", def + "%");
    setText("cra_docs", docScore + "%");
    setText("cra_total", total + "%");

    // Flags/recs
    const flags = [];
    if(primary < 2) flags.push("• Primary purpose is not clearly stated. Strengthen the community development purpose statement and beneficiary definition.");
    if(lmi < 50) flags.push("• LMI targeting appears low. Consider tighter eligibility method or service geography aligned to LMI tracts.");
    if(aa < 50) flags.push("• Assessment area attribution is weak. Add ZIP/tract capture and AA mapping to improve exam defensibility.");
    if(resp < 2) flags.push("• Link to documented need is not strong. Use Tier 1 evidence excerpts and cite the specific disparity/priority.");
    if(docScore < 70) flags.push("• Documentation readiness is incomplete. Use the checklist to close gaps before pitching to bank compliance.");

    if(activity === "nmt"){
      flags.push("• NEMT best practice: retain ride logs, completed visit linkage, beneficiary ZIP/tract, and a monthly exception report (cancellations/no-shows).");
    }
    if(structure === "grant"){
      flags.push("• Grant structure: ensure partner eligibility and written agreement specify the community service purpose and reporting requirements.");
    } else if(structure === "loan"){
      flags.push("• Loan structure: document community development purpose and primary beneficiaries; include reporting covenants for units served.");
    } else if(structure === "investment"){
      flags.push("• Investment structure: retain evidence the recipient qualifies (e.g., CDFI) and the investment supports eligible community development.");
    } else if(structure === "service"){
      flags.push("• Service structure: document staff hours, nature of service, and the community development purpose/beneficiaries.");
    }

    setText("cra_flags", flags.length ? flags.join("
") : "No major red flags detected. Proceed to Tier 3 ROI and Tier 4 implementation planning.");

    // Narrative starter (exam style)
    const iri = document.getElementById("kpi_iri")?.textContent || "—";
    const narr =
`Exam-style narrative starter (draft)

The institution supported a community development activity structured as a ${structure} to advance community services targeted to low- or moderate-income individuals.
The activity was responsive to documented community needs identified through the CHNA/CHIP process (Tier 1 Investment Readiness Index: ${iri}).
The institution maintained an audit trail including beneficiary eligibility method, assessment area attribution, and service/unit logs to substantiate impact.

Key quantification targets (to populate as program runs):
- LMI share (target): ${lmi}%
- Assessment area attribution (target): ${aa}%
- Documentation readiness (current): ${docScore}%

Next steps:
1) Finalize beneficiary definition + AA capture.
2) Execute a 30–90 day pilot with monthly monitoring.
3) Produce quarterly outcomes reporting for CRA file.`;
    setText("cra_narr", narr);

    // Gate: Tier3 unlock if Tier1 IRI >=55 and total >=60
    const iriVal = parseInt((document.getElementById("kpi_iri")?.textContent || "0").replace("%",""),10) || 0;
    const unlocked = (iriVal >= 55 && total >= 60);
    const dot = document.getElementById("gateDot");
    if(dot){
      dot.classList.remove("good","bad");
      dot.classList.add(unlocked ? "good" : "bad");
    }
    const gt = document.getElementById("gateText");
    if(gt){
      gt.textContent = unlocked ? "Tier 3 unlocked (Tier 1 IRI ≥ 55 and Tier 2 ≥ 60)" : "Run Tier 1 + Tier 2 to unlock Tier 3";
    }

    state.cra.score = {elig, def, docScore, total, lmi, aa, primary, resp, complex, lead, activity, structure};
    showOk("Tier 2 calculated.");
  }

  function populateCRAFromTier1(){
    // Use Tier 1 transport signal and gaps as a hint for responsiveness
    const trans = document.getElementById("kpi_trans")?.textContent || "";
    const gapText = document.getElementById("gap_box")?.textContent || "";
    const respSel = document.getElementById("cra_resp");
    if(respSel){
      respSel.value = trans && trans !== "—" ? "2" : "1";
    }
    // If written comment gaps exist, encourage doc readiness checkbox for report/monitor
    if(gapText.toLowerCase().includes("written comment")){
      const report = document.querySelector('.cra_doc[value="report"]');
      if(report) report.checked = True if False else report.checked;
    }
    showOk("Tier 2 inputs updated using Tier 1 signals (verify and adjust).");
  }

  // sliders readouts
  (function(){
    const aa = document.getElementById("cra_aa");
    const lmi = document.getElementById("cra_lmi");
    const aaR = document.getElementById("cra_aa_read");
    const lmiR = document.getElementById("cra_lmi_read");
    if(aa && aaR){ aaR.textContent = aa.value + "%"; aa.addEventListener("input", ()=> aaR.textContent = aa.value + "%"); }
    if(lmi && lmiR){ lmiR.textContent = lmi.value + "%"; lmi.addEventListener("input", ()=> lmiR.textContent = lmi.value + "%"); }
  })();

</script>
</body>
</html>
