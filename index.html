<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CHNA–CRA Navigation Dashboard (Production)</title>

<!-- PDF.js (CDN). If blocked/unavailable, the app falls back to Assisted Mode (manual evidence). -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root{
  --blue:#1f7fd6; --green:#18a76f; --ink:#0b1f33; --muted:#2f4556;
  --border:rgba(11,31,51,.16); --bg1:#e7f3ff; --bg2:#e7fbf2; --card:#ffffff;
  --warn:#d78b00; --bad:#d93b3b;
  --shadow:0 12px 28px rgba(11,31,51,.06);
  --radius:16px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1100px 520px at 15% 10%, var(--bg1), rgba(255,255,255,0)),
    radial-gradient(1100px 520px at 85% 20%, var(--bg2), rgba(255,255,255,0)),
    linear-gradient(180deg, #ffffff, #f7fbff);
  color:var(--ink);
  font-size:16px;
  line-height:1.45;
}
header{
  padding:14px 18px 12px 18px;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,.92);
  position:sticky; top:0; z-index:10;
  backdrop-filter: blur(8px);
}
.wrap{max-width:1320px;margin:0 auto;padding:14px 18px 40px;}
h1{margin:0;font-size:20px;}
.sub{margin-top:4px;color:var(--muted);font-size:13px;}
.grid{display:grid; gap:12px;}
.grid-2{grid-template-columns: 420px 1fr;}
@media (max-width: 980px){ .grid-2{grid-template-columns:1fr;} }
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}
.btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;}
button{
  border:1px solid var(--border); background:#fff; border-radius:12px;
  padding:8px 12px; font-weight:900; cursor:pointer;
}
button.primary{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
button.secondary{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
button.danger{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}
.tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center;}
.tabbtn{
  border:1px solid var(--border); background:#fff; border-radius:999px;
  padding:8px 12px; font-weight:900; cursor:pointer;
}
.tabbtn.active{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
.pill{
  display:inline-block; padding:2px 10px; border-radius:999px;
  background:rgba(31,127,214,.10); border:1px solid rgba(31,127,214,.22);
  font-size:12px; font-weight:800;
}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--border); background:#fff;
  font-size:12px; font-weight:900; color:var(--ink);
}
.small{font-size:12px;color:var(--muted);}
.mono{font-family:var(--mono);}
.kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:10px;}
@media (max-width: 980px){ .kpis{grid-template-columns:1fr;} }
.kpi{
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  background:#fff;
}
.kpi .label{font-size:12px;color:var(--muted);font-weight:800;}
.kpi .value{font-size:22px;font-weight:900;margin-top:2px;}
.kpi .hint{font-size:12px;color:var(--muted); margin-top:4px; line-height:1.35;}
table{width:100%; border-collapse:collapse; font-size:13px;}
th,td{border:1px solid var(--border); padding:8px; vertical-align:top;}
th{background:rgba(31,127,214,.08); text-align:left;}
.callout{
  border:1px dashed rgba(11,31,51,.25);
  border-radius:14px;
  padding:10px 12px;
  background: rgba(255,255,255,.7);
}
.okbar{
  display:none; border:1px solid rgba(24,167,111,.35); background:rgba(24,167,111,.08);
  border-radius:14px; padding:10px 12px; margin-top:12px;
}
.errbar{
  display:none; border:1px solid rgba(217,59,59,.35); background:rgba(217,59,59,.08);
  border-radius:14px; padding:10px 12px; margin-top:12px;
}
.view{display:none;}
.view.active{display:block;}
.row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
.field{flex:1 1 320px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff;}
.field label{display:flex; justify-content:space-between; gap:10px; font-weight:900; font-size:13px;}
input, select, textarea{
  width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:12px;
  font-size:14px; color:var(--ink); background:#fff;
}
textarea{min-height:88px; resize:vertical;}
.codebox{
  font-family:var(--mono);
  font-size:12px;
  white-space:pre-wrap;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#fff;
  color:var(--ink);
}
.split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
@media (max-width:980px){ .split{grid-template-columns:1fr;} }
.gate{margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.dot{width:10px;height:10px;border-radius:999px;background: var(--warn);border:1px solid rgba(0,0,0,.08);}
.dot.good{background: var(--green);}
.dot.bad{background: var(--bad);}
</style>
</head>

<body>
<header>
  <div class="wrap" style="padding:0 18px;">
    <h1>CHNA–CRA Navigation Dashboard</h1>
    <div class="sub">Production build (local): Tier 1 Assessment → Tier 2 CRA Rule Engine → Tier 3 ROI (Excel parity) → Robust Artifacts</div>

    <div class="tabs" aria-label="Navigation tabs">
      <button class="tabbtn active" id="tab_overview" onclick="setView('overview')">Overview</button>
      <button class="tabbtn" id="tab_t1" onclick="setView('t1')">Tier 1 — Assessment</button>
      <button class="tabbtn" id="tab_t2" onclick="setView('t2')">Tier 2 — CRA Rule Engine</button>
      <button class="tabbtn" id="tab_t3" onclick="setView('t3')">Tier 3 — ROI</button>
      <button class="tabbtn" id="tab_t4" onclick="setView('t4')">Tier 4 — Implementation</button>
      <button class="tabbtn" id="tab_t5" onclick="setView('t5')">Tier 5 — Outcomes</button>
      <button class="tabbtn" id="tab_t6" onclick="setView('t6')">Tier 6 — Evaluation</button>
      <button class="tabbtn" id="tab_drafts" onclick="setView('drafts')">Artifacts</button>

      <div class="gate">
        <span class="chip"><span id="gateDot" class="dot bad"></span> <span id="gateText">Run Tier 1 to unlock Tier 2/3</span></span>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="errbar" class="errbar"></div>
  <div id="okbar" class="okbar"></div>

  <div class="grid grid-2">
    <!-- LEFT PANEL -->
    <div class="card">
      <div class="btnbar">
        <button class="primary" onclick="processFiles()">Process Files</button>
        <button class="secondary" onclick="loadDemo()">Load Demo</button>
        <button onclick="exportJSON()">Export JSON</button>
        <button class="danger" onclick="resetAll()">Reset</button>
      </div>

      <div class="field">
        <label><span>Upload PDFs (CHNA / CHIP / Schedule H)</span><span class="pill">PDF/TXT</span></label>
        <input id="file_input" type="file" multiple accept=".pdf,.txt"/>
        <div class="small" style="margin-top:8px;">
          Parsing runs locally using pdf.js when available. If pdf.js is blocked, you can still proceed by pasting excerpts into evidence fields (Assisted Mode).
        </div>
        <div id="proc_log" class="codebox" style="margin-top:10px; min-height:160px;">(processing log)</div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label><span>CHNA Web Links (StoryMaps etc.)</span><span class="pill">Multi‑URL</span></label>
        <div class="row" style="margin-top:0;">
          <input id="url_input" type="text" placeholder="Paste a URL and click Add"/>
          <button class="secondary" type="button" onclick="addURL()">Add</button>
        </div>
        <div id="url_list" class="codebox" style="margin-top:8px; min-height:84px;">(no URLs added)</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="chip">Docs: <span class="mono" id="docs_count">0</span></div>
        <div class="chip">Evidence: <span class="mono" id="ev_count">0</span></div>
        <div class="chip">IRI: <span class="mono" id="iri_small">—</span></div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">If pdf parsing fails</div>
        <div class="small" style="margin-top:6px;">
          You will see a log line explaining why. You can still complete Tier 1 by setting scores and pasting excerpts in evidence fields.
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="card">

      <!-- OVERVIEW -->
      <section id="view_overview" class="view active">
        <div class="callout">
          <div style="font-weight:900;">Tiered Question Framework</div>
          <div class="small" style="margin-top:6px;">Use this as your pitch roadmap.</div>
        </div>
        <div class="card" style="box-shadow:none; margin-top:12px;">
          <table>
            <tr><th>Tier</th><th>Core question</th><th>Outputs</th></tr>
            <tr><td><b>Tier 1</b></td><td>Is the CHNA structurally accountable and aligned to CHIP/implementation?</td><td>Structural, input, alignment scores; IRI; gaps</td></tr>
            <tr><td><b>Tier 2</b></td><td>Is the activity CRA‑eligible and examiner‑defensible?</td><td>CRA scores; flags; exam‑style narrative</td></tr>
            <tr><td><b>Tier 3</b></td><td>Is the intervention financially disciplined and what is break‑even?</td><td>Excel‑parity ROI + audit summary</td></tr>
            <tr><td><b>Tier 4</b></td><td>How do we operationalize in 30–90 days with an audit trail?</td><td>Implementation plan template</td></tr>
            <tr><td><b>Tier 5</b></td><td>What will we report monthly/quarterly to leadership and examiners?</td><td>Outcomes reporting template</td></tr>
            <tr><td><b>Tier 6</b></td><td>How do we evaluate long‑term impact and close the loop?</td><td>Evaluation plan template</td></tr>
          </table>
        </div>
      </section>

      <!-- TIER 1 -->
      <section id="view_t1" class="view">
        <div class="kpis">
          <div class="kpi"><div class="label">Structural</div><div class="value" id="kpi_struct">—</div><div class="hint">IRS documentation completeness.</div></div>
          <div class="kpi"><div class="label">Community input</div><div class="value" id="kpi_input">—</div><div class="hint">Written comments scoring.</div></div>
          <div class="kpi"><div class="label">Alignment</div><div class="value" id="kpi_align">—</div><div class="hint">CHNA ↔ CHIP operationalization.</div></div>
          <div class="kpi"><div class="label">IRI</div><div class="value" id="kpi_iri">—</div><div class="hint">40/20/40 weighted.</div></div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Accountability rubric (0–2)</div>
            <div class="small" style="margin-bottom:10px;">Auto-prefill uses keywords. Override as needed and add evidence.</div>
            <div style="overflow:auto;"><table id="tbl_rubric"></table></div>
            <div class="row">
              <button class="secondary" type="button" onclick="prefillRubric()">Auto-prefill</button>
              <button type="button" onclick="scoreAll()">Recalculate</button>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">CHNA–CHIP alignment</div>
            <div class="row" style="margin-top:0;">
              <div class="field"><label>CHNA document</label><select id="sel_chna"></select></div>
              <div class="field"><label>CHIP/Plan document</label><select id="sel_chip"></select></div>
            </div>
            <div class="split" style="margin-top:10px;">
              <div><div style="font-weight:900; margin-bottom:6px;">Detected priorities</div><div id="prio_box" class="codebox" style="min-height:200px;">Process files to extract priorities.</div></div>
              <div><div style="font-weight:900; margin-bottom:6px;">Alignment rubric</div><div style="overflow:auto;"><table id="tbl_align"></table></div>
                <div class="row">
                  <button class="secondary" type="button" onclick="prefillAlignment()">Auto-prefill alignment</button>
                  <button type="button" onclick="scoreAll()">Recalculate</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Gaps & recommendations</div>
            <div id="gap_box" class="codebox" style="min-height:220px;">Run Tier 1 to populate.</div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Evidence snippets</div>
            <div style="overflow:auto;"><table id="tbl_evidence"></table></div>
          </div>
        </div>
      </section>

      <!-- TIER 2 -->
      <section id="view_t2" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 2 — CRA Rule Engine</div>
          <div class="small" style="margin-top:6px;">Embedded logic: primary purpose, LMI, AA, responsiveness, documentation readiness.</div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="kpis">
            <div class="kpi"><div class="label">Eligibility</div><div class="value" id="cra_elig">—</div><div class="hint">Primary purpose + LMI + AA.</div></div>
            <div class="kpi"><div class="label">Defensibility</div><div class="value" id="cra_def">—</div><div class="hint">Responsiveness + complexity + leadership.</div></div>
            <div class="kpi"><div class="label">Docs readiness</div><div class="value" id="cra_docs">—</div><div class="hint">Checklist completeness.</div></div>
            <div class="kpi"><div class="label">Total Tier 2</div><div class="value" id="cra_total">—</div><div class="hint">Unlock Tier 3 when ≥ 60.</div></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="field"><label>Activity</label>
              <select id="cra_activity">
                <option value="nmt" selected>NEMT / Transportation‑to‑care</option>
                <option value="food">Food access support</option>
                <option value="care">Care navigation</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="field"><label>Structure</label>
              <select id="cra_structure">
                <option value="grant" selected>Grant/donation</option>
                <option value="service">Service (staff time)</option>
                <option value="investment">Investment</option>
                <option value="loan">CD loan</option>
              </select>
            </div>
            <div class="field">
              <label>AA attribution (%) <span class="mono" id="cra_aa_read">100%</span></label>
              <input id="cra_aa" type="range" min="0" max="100" value="100"/>
            </div>
            <div class="field">
              <label>LMI targeting (%) <span class="mono" id="cra_lmi_read">90%</span></label>
              <input id="cra_lmi" type="range" min="0" max="100" value="90"/>
            </div>
          </div>

          <div class="row">
            <div class="field"><label>Primary purpose clarity</label>
              <select id="cra_primary"><option value="2" selected>Clear</option><option value="1">Partial</option><option value="0">Unclear</option></select>
            </div>
            <div class="field"><label>Responsiveness</label>
              <select id="cra_resp"><option value="2" selected>High</option><option value="1">Moderate</option><option value="0">Low</option></select>
            </div>
            <div class="field"><label>Complexity</label>
              <select id="cra_complex"><option value="2">High</option><option value="1" selected>Moderate</option><option value="0">Low</option></select>
            </div>
            <div class="field"><label>Leadership</label>
              <select id="cra_lead"><option value="2">Leader</option><option value="1" selected>Participant</option><option value="0">Minimal</option></select>
            </div>
          </div>

          <div class="callout" style="margin-top:10px;">
            <div style="font-weight:900;">Documentation checklist</div>
            <div class="row" style="margin-top:10px;">
              <div class="field"><label><input type="checkbox" class="cra_doc" checked/> CHNA/CHIP excerpt(s)</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc" checked/> LMI method</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc" checked/> AA attribution method</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc" checked/> Agreement/MOU</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc"/> Invoices/payments</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc"/> Service/unit logs</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc"/> Monitoring cadence</label></div>
              <div class="field"><label><input type="checkbox" class="cra_doc"/> Quarterly report</label></div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:12px;">
            <button class="primary" type="button" onclick="runCRAEngine()">Calculate</button>
            <button class="secondary" type="button" onclick="populateCRAFromTier1()">Use Tier 1 hints</button>
          </div>

          <div class="split" style="margin-top:12px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Flags & recommendations</div>
              <div id="cra_flags" class="codebox" style="min-height:220px;">Run Tier 2 to populate.</div>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Exam‑style narrative starter</div>
              <div id="cra_narr" class="codebox" style="min-height:220px;">Run Tier 2 to populate.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- TIER 3 -->
      <section id="view_t3" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 3 — ROI (Excel parity)</div>
          <div class="small" style="margin-top:6px;">Outputs stored and used to populate P&L and Pro Forma.</div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="row">
            <div class="field"><label>Annual visits</label><input id="a_visits" type="number" value="40000"/></div>
            <div class="field"><label>No-show rate</label><input id="a_noshow" type="number" value="0.20" step="0.01"/></div>
            <div class="field"><label>Transport share</label><input id="a_share" type="number" value="0.30" step="0.01"/></div>
            <div class="field"><label>Net rev/visit ($)</label><input id="a_netrev" type="number" value="225"/></div>
            <div class="field"><label>Marginal cost/visit ($)</label><input id="a_margc" type="number" value="90"/></div>
          </div>
          <div class="row">
            <div class="field"><label>Mitigation rate</label><input id="b_mitig" type="number" value="0.50" step="0.01"/></div>
            <div class="field"><label>Trip cost ($)</label><input id="b_trip" type="number" value="60"/></div>
            <div class="field"><label>Overhead rate</label><input id="b_over" type="number" value="0.10" step="0.01"/></div>
          </div>
          <div class="btnbar">
            <button class="primary" type="button" onclick="renderROI()">Run ROI</button>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="label">Net benefit</div><div class="value" id="roi_net">—</div></div>
            <div class="kpi"><div class="label">Program cost</div><div class="value" id="roi_cost">—</div></div>
            <div class="kpi"><div class="label">ROI (x)</div><div class="value" id="roi_x">—</div></div>
            <div class="kpi"><div class="label">Break-even trip cost max</div><div class="value" id="roi_be">—</div></div>
          </div>
          <div class="card" style="box-shadow:none; margin-top:12px;">
            <div id="roi_audit" class="codebox" style="min-height:220px;">Run ROI to populate audit summary.</div>
          </div>
        </div>
      </section>

      <section id="view_t4" class="view"><div class="callout"><div style="font-weight:900;">Tier 4 — Implementation (prototype)</div><div class="small" style="margin-top:6px;">Template placeholders for pitch.</div></div><div class="card" style="box-shadow:none; margin-top:12px;"><div class="codebox" style="min-height:220px;">(Prototype) 30–60–90 day implementation plan template.</div></div></section>
      <section id="view_t5" class="view"><div class="callout"><div style="font-weight:900;">Tier 5 — Outcomes (prototype)</div><div class="small" style="margin-top:6px;">Template placeholders for pitch.</div></div><div class="card" style="box-shadow:none; margin-top:12px;"><div class="codebox" style="min-height:220px;">(Prototype) Quarterly outcomes report template.</div></div></section>
      <section id="view_t6" class="view"><div class="callout"><div style="font-weight:900;">Tier 6 — Evaluation (prototype)</div><div class="small" style="margin-top:6px;">Template placeholders for pitch.</div></div><div class="card" style="box-shadow:none; margin-top:12px;"><div class="codebox" style="min-height:220px;">(Prototype) Evaluation plan template.</div></div></section>

      <!-- ARTIFACTS section already above -->
    </div>
  </div>
</div>

<script>
// (script continues above; this tag placeholder ensures file integrity)
</script>

</body>
</html>
