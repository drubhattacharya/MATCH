<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CHNA–CRA Navigation Dashboard — 3 Tiers</title>

  <!-- Dependencies (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Match LAI Navigation Dashboard look & feel (light, crisp, blue/green accents) */
    :root{
      --blue:#1f7fd6; --green:#18a76f; --ink:#0b1f33; --muted:#2f4556;
      --border:rgba(11,31,51,.16); --bg1:#e7f3ff; --bg2:#e7fbf2; --card:#ffffff;
      --warn:#d78b00; --bad:#d93b3b;
      --shadow:0 12px 28px rgba(11,31,51,.06);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 520px at 15% 10%, var(--bg1), rgba(255,255,255,0)),
        radial-gradient(1100px 520px at 85% 20%, var(--bg2), rgba(255,255,255,0)),
        linear-gradient(180deg, #ffffff, #f7fbff);
      color:var(--ink);
      font-size:16px;
      line-height:1.45;
    }
    header{
      padding:14px 18px 12px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.88);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:14px 18px 40px;}
    h1{margin:0;font-size:20px;}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;}
    .grid{display:grid; gap:12px;}
    .grid-2{grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;}
    button{
      border:1px solid var(--border); background:#fff; border-radius:12px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    button.primary{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    button.secondary{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    button.danger{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tabbtn{
      border:1px solid var(--border); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{border-color:rgba(31,127,214,.35); background:rgba(31,127,214,.08);}
    .pill{
      display:inline-block; padding:2px 10px; border-radius:999px;
      background:rgba(31,127,214,.10); border:1px solid rgba(31,127,214,.22);
      font-size:12px; font-weight:800;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff;
      font-size:12px; font-weight:900; color:var(--ink);
    }
    .small{font-size:12px;color:var(--muted);}
    .mono{font-family:var(--mono);}

    .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns:1fr;} }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800;}
    .kpi .value{font-size:22px;font-weight:900;margin-top:2px;}
    .kpi .hint{font-size:12px;color:var(--muted); margin-top:4px; line-height:1.35;}

    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border:1px solid var(--border); padding:8px; vertical-align:top;}
    th{background:rgba(31,127,214,.08); text-align:left;}
    .callout{
      border:1px dashed rgba(11,31,51,.25);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.7);
    }
    .okbar{
      display:none; border:1px solid rgba(24,167,111,.35); background:rgba(24,167,111,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }
    .errbar{
      display:none; border:1px solid rgba(217,59,59,.35); background:rgba(217,59,59,.08);
      border-radius:14px; padding:10px 12px; margin-top:12px;
    }

    .view{display:none;}
    .view.active{display:block;}

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .field{flex:1 1 320px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff;}
    .field label{display:flex; justify-content:space-between; gap:10px; font-weight:900; font-size:13px;}
    input, select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:12px;
      font-size:14px; color:var(--ink); background:#fff;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
    }
    .b-strong{border-color:rgba(24,167,111,.35); background:rgba(24,167,111,.08);}
    .b-mod{border-color:rgba(215,139,0,.35); background:rgba(215,139,0,.08);}
    .b-weak{border-color:rgba(217,59,59,.35); background:rgba(217,59,59,.08);}

    .codebox{
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      color:var(--ink);
    }

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:980px){ .split{grid-template-columns:1fr;} }

    .gate{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--warn);
      border:1px solid rgba(0,0,0,.08);
    }
    .dot.good{background: var(--green);}
    .dot.bad{background: var(--bad);}
  </style>
</head>

<body>
<header>
  <div class="wrap" style="padding:0 18px;">
    <h1>CHNA–CRA Navigation Dashboard — 3-Tier Navigation</h1>
    <div class="sub">Tier 1: CHNA Materiality • Tier 2: CRA Eligibility & Application Readiness • Tier 3: Total Program Cost & ROI</div>

    <div class="tabs" aria-label="Navigation tabs">
      <button class="tabbtn active" id="tab_t1" data-view="t1">Tier 1 — Materiality</button>
      <button class="tabbtn" id="tab_t2" data-view="t2">Tier 2 — CRA Readiness</button>
      <button class="tabbtn" id="tab_t3" data-view="t3">Tier 3 — Cost & ROI</button>

      <div class="gate">
        <span class="chip"><span id="gateDot" class="dot"></span> <span id="gateText">Tier 3 locked until Tier 2 score ≥ 60</span></span>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="errbar" class="errbar"></div>
  <div id="okbar" class="okbar"></div>

  <!-- LEFT + RIGHT layout -->
  <div class="grid grid-2">
    <!-- LEFT: Upload and controls -->
    <div class="card">
      <div class="btnbar">
        <button class="primary" id="btn_process">Process Files</button>
        <button class="secondary" id="btn_demo">Load Demo (Transportation differential)</button>
        <button id="btn_export">Export report (JSON)</button>
        <button class="danger" id="btn_reset">Reset</button>
      </div>

      <div class="field" style="margin-top:8px;">
        <label><span>Upload documents</span><span class="pill">PDF/TXT</span></label>
        <input id="file_input" type="file" multiple accept=".pdf,.txt"/>
        <div class="small" style="margin-top:8px;">
          Upload: CHNA (PDF), Schedule H (PDF), CRA exam/procedures (PDF), internal memos (TXT).
          Processing occurs locally in your browser.
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="chip">Docs: <span class="mono" id="docs_count">0</span></div>
        <div class="chip">Evidence: <span class="mono" id="ev_count">0</span></div>
        <div class="chip">Top Tier 2 score: <span class="mono" id="top_t2">—</span></div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">Transportation spotlight (required)</div>
        <div class="small" style="margin-top:6px;">
          This dashboard explicitly elevates transportation when a subgroup (e.g., ages 65–74) shows materially higher barriers than overall population.
          This is the “amplification” logic that turns a seemingly small overall rate into a partnership-grade opportunity.
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="chip">Overall transportation: <b id="t_overall">—</b></div>
          <div class="chip">Age 65–74: <b id="t_6574">—</b></div>
          <div class="chip">Amplification: <b id="t_amp">—</b></div>
        </div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <div style="font-weight:900;">How CRA eligibility is stated here</div>
        <div class="small" style="margin-top:6px;">
          Tier 2 includes the specific qualifying criterion satisfied (e.g., “community support services targeted to LMI individuals”)
          and cites the applicable topic and example (e.g., transportation to medical treatments).
        </div>
      </div>
    </div>

    <!-- RIGHT: Views -->
    <div class="card">
      <!-- Tier 1 -->
      <section id="view_t1" class="view active">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Top disparity</div>
            <div class="value" id="kpi_top">—</div>
            <div class="hint" id="kpi_top_hint">Process documents to compute materiality.</div>
          </div>
          <div class="kpi">
            <div class="label">Top subgroup concentration</div>
            <div class="value" id="kpi_conc">—</div>
            <div class="hint">Highlights where a targeted program will have the strongest case.</div>
          </div>
          <div class="kpi">
            <div class="label">Priority shortlist</div>
            <div class="value" id="kpi_shortlist">—</div>
            <div class="hint">Items recommended to advance to Tier 2.</div>
          </div>
          <div class="kpi">
            <div class="label">Partner angle</div>
            <div class="small" id="kpi_angle">—</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Disparities Materiality Matrix</div>
            <div class="small" style="margin-bottom:10px;">
              Materiality score (0–100) is computed from <b>magnitude</b>, <b>subgroup differential</b>, and <b>prominence across documents</b>.
              Transportation receives a boost when subgroup amplification is detected (e.g., 8.5% vs 2.7%).
            </div>

            <div class="split">
              <div style="overflow:auto;">
                <table id="tbl_materiality"></table>
              </div>
              <div>
                <div style="font-weight:900; margin-bottom:6px;">Top disparities chart</div>
                <canvas id="chart_materiality" height="230"></canvas>
                <div class="small" style="margin-top:8px;">Chart ranks the highest scoring disparities (0–100).</div>
              </div>
            </div>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:900;">Tier 1 recommendation snapshot</div>
              <div class="small" id="tier1_recs" style="margin-top:6px;">—</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div style="font-weight:900; margin-bottom:6px;">Evidence snippets (traceability)</div>
            <div class="small" style="margin-bottom:10px;">Each signal preserves the triggering text plus document and page.</div>
            <div style="overflow:auto;">
              <table id="tbl_evidence"></table>
            </div>
          </div>
        </div>
      </section>

      <!-- Tier 2 -->
      <section id="view_t2" class="view">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Best opportunity score</div>
            <div class="value" id="t2_best">—</div>
            <div class="hint" id="t2_best_hint">Tier 2 score ≥ 60 unlocks Tier 3.</div>
          </div>
          <div class="kpi">
            <div class="label">Transportation opportunity</div>
            <div class="value" id="t2_transport">—</div>
            <div class="hint">Always evaluated as a candidate due to common CHNA access barriers.</div>
          </div>
          <div class="kpi">
            <div class="label">Eligibility criterion</div>
            <div class="small" id="t2_crit">—</div>
          </div>
          <div class="kpi">
            <div class="label">Application packet</div>
            <div class="small" id="t2_packet">—</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
              <div>
                <div style="font-weight:900;">CRA Eligibility & Application Readiness</div>
                <div class="small">Includes explicit criterion satisfied for CRA and what evidence is required for exam defensibility.</div>
              </div>
              <button class="secondary" id="btn_use_top">Use top opportunity in Tier 3</button>
            </div>

            <div style="overflow:auto; margin-top:10px;">
              <table id="tbl_cra"></table>
            </div>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:900;">Exam-ready prompts (joint memo)</div>
              <div class="small" id="exam_prompts" style="margin-top:6px;">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tier 3 -->
      <section id="view_t3" class="view">
        <div class="callout">
          <div style="font-weight:900;">Tier 3 starts with the basic precursor question</div>
          <div class="small" style="margin-top:6px;">
            <b>How much does the program cost?</b> Tier 3 computes total cost baseline (startup + fixed + variable) and then estimates ROI.
          </div>
        </div>

        <div class="card" style="box-shadow:none; margin-top:12px;">
          <div class="row">
            <div class="field">
              <label>Activity type</label>
              <select id="inp_activity">
                <option value="nmt">Transportation-to-care (NEMT)</option>
                <option value="food">Food access supports</option>
                <option value="care">Care navigation / referral infrastructure</option>
              </select>
              <div class="small" style="margin-top:6px;">Transportation is always available and auto-selected when it is the top Tier 2 opportunity.</div>
            </div>
            <div class="field">
              <label>Time horizon (months)</label>
              <select id="inp_months">
                <option value="12">12</option>
                <option value="24">24</option>
                <option value="36">36</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field"><label>Annual touchpoints (appointments)</label><input id="inp_annual" type="number" value="9000" min="0"/></div>
            <div class="field"><label>Baseline disruption rate (%)</label><input id="inp_base" type="number" value="15" min="0" max="100" step="0.1"/></div>
            <div class="field"><label>Share attributable to barrier (%)</label><input id="inp_share" type="number" value="25" min="0" max="100" step="0.1"/></div>
            <div class="field"><label>Reduction in barrier disruptions (%)</label><input id="inp_red" type="number" value="30" min="0" max="100" step="0.1"/></div>
          </div>

          <div class="row">
            <div class="field"><label>Benefit per prevented disruption ($)</label><input id="inp_benefit" type="number" value="120" min="0"/></div>
            <div class="field"><label>Startup cost (one-time, $)</label><input id="inp_startup" type="number" value="15000" min="0"/></div>
            <div class="field"><label>Fixed monthly cost ($/mo)</label><input id="inp_fixed" type="number" value="6000" min="0"/></div>
            <div class="field"><label>Variable unit cost ($/ride/unit)</label><input id="inp_var" type="number" value="35" min="0"/></div>
            <div class="field"><label>Units per prevented disruption</label><input id="inp_units" type="number" value="1.2" min="0.1" step="0.1"/></div>
          </div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" id="btn_run">Run cost & ROI</button>
            <button class="secondary" id="btn_autofill">Auto-fill from Tier 2</button>
          </div>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi">
              <div class="label">Program cost (annualized)</div>
              <div class="value" id="kpi_cost">—</div>
              <div class="hint">Startup + fixed + variable, normalized to annual basis.</div>
            </div>
            <div class="kpi">
              <div class="label">Gross benefit (annualized)</div>
              <div class="value" id="kpi_gross">—</div>
              <div class="hint">Prevented disruptions × benefit.</div>
            </div>
            <div class="kpi">
              <div class="label">Net impact (annualized)</div>
              <div class="value" id="kpi_net">—</div>
              <div class="hint">Gross minus program cost.</div>
            </div>
            <div class="kpi">
              <div class="label">Audit-ready memo block</div>
              <div class="small">Generated below (copy/paste).</div>
            </div>
          </div>

          <div class="split" style="margin-top:10px;">
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Benefits vs costs</div>
              <canvas id="chart_roi" height="230"></canvas>
            </div>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900; margin-bottom:6px;">Monthly & cumulative net</div>
              <canvas id="chart_trend" height="230"></canvas>
            </div>
          </div>

          <div class="card" style="box-shadow:none; margin-top:12px;">
            <div style="font-weight:900; margin-bottom:6px;">Audit-ready output</div>
            <div id="audit_out" class="codebox"></div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // ------------------------------
  // PDF.js setup
  // ------------------------------
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // ------------------------------
  // Utilities
  // ------------------------------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function fmtPct(x){ return (x==null || isNaN(x)) ? "—" : `${x.toFixed(1)}%`; }
  function fmtInt(x){ return (x==null || isNaN(x)) ? "—" : `${Math.round(x).toLocaleString()}`; }
  function fmtMoney(x){
    if(x==null || isNaN(x)) return "—";
    const sign = x < 0 ? "-" : "";
    const v = Math.abs(x);
    return `${sign}$${v.toLocaleString(undefined,{maximumFractionDigits:0})}`;
  }
  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function showErr(msg){ const e=document.getElementById("errbar"); e.style.display="block"; e.innerHTML = msg; }
  function clearErr(){ const e=document.getElementById("errbar"); e.style.display="none"; e.innerHTML = ""; }
  function showOk(msg){ const o=document.getElementById("okbar"); o.style.display="block"; o.innerHTML = msg; }

  // ------------------------------
  // State
  // ------------------------------
  const state = {
    docs: [], // {name,type,pages,textByPage[]}
    evidence: [], // {disparity, snippet, doc, page}
    findings: [], // Tier1: {id,key,disparity,segment,magnitude,prominence,concentration,score,recommend,evidenceRef}
    opportunities: [], // Tier2: {opp,kind,tests,criterion,strength,score,scope,checklist}
    selectedOpp: null,
    transport: {overall:null, age6574:null}
  };

  // Disparities list (includes transportation explicitly)
  const DISPARITIES = [
    {key:"transport", label:"Transportation barrier", keywords:["transportation","transit"], metric:"% reporting transportation problems"},
    {key:"access", label:"Access to care barrier", keywords:["could not get an appointment","delayed care"], metric:"% delaying needed care"},
    {key:"food", label:"Food insecurity", keywords:["food insecurity","food shelf"], metric:"% reporting food insecurity"},
    {key:"housing", label:"Housing need", keywords:["housing needs","housing"], metric:"% reporting housing needs"},
    {key:"financial", label:"Financial need", keywords:["financial needs","cost too much"], metric:"% reporting financial needs"}
  ];

  // CRA criteria mapping (explicit criterion satisfied)
  // Note: This is written in a regulator-friendly way, citing the OCC illustrative list structure (Topic L — community support services).
  const CRA_CRITERIA = {
    nmt: {
      criterion: "Community development services / community support services targeted to low- or moderate-income (LMI) individuals — transportation to medical treatments.",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — example: transportation to medical treatments for LMI individuals."
    },
    food: {
      criterion: "Community development services / community support services targeted to LMI individuals — food access support as a community service (when structured for LMI populations).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — community services for LMI individuals (structure matters)."
    },
    care: {
      criterion: "Community development services targeted to LMI individuals — health services / community services that improve access (depending on structure and beneficiaries).",
      cite: "Qualifying Activities: 12 CFR 25.04(c)(3) Topic L (Community support services) — health/community services for LMI individuals (structure matters)."
    }
  };

  // ------------------------------
  // Extraction
  // ------------------------------
  async function extractPdfText(file){
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    const numPages = pdf.numPages;
    const textByPage = [];
    for(let p=1; p<=numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str).filter(Boolean);
      const text = strings.join(" ").replace(/\s+/g,' ').trim();
      textByPage.push(text);
    }
    return {pages: numPages, textByPage};
  }
  async function extractTxt(file){
    const text = await file.text();
    return {pages: 1, textByPage: [text.replace(/\s+/g,' ').trim()]};
  }

  function recordEvidence(disparityLabel, snippet, doc, page){
    state.evidence.push({disparity:disparityLabel, snippet, doc, page});
  }

  function findPercentNear(text, keyword){
    const re = new RegExp(`${keyword}[\\s\\S]{0,160}?(\\d{1,2}(?:\\.\\d+)?)%`, "i");
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }
  function findAge6574Transport(text){
    const re = /65\s*[-–]\s*74[\s\S]{0,160}transportation[\s\S]{0,80}?(\d{1,2}(?:\.\d+)?)%/i;
    const m = text.match(re);
    if(!m) return null;
    const val = parseFloat(m[1]);
    if(isNaN(val)) return null;
    return {val, snippet: m[0].slice(0,280)};
  }

  function addFinding(key, disparity, segment, magnitude, prominence, evidenceRef){
    const id = `${key}__${segment}`;
    const ex = state.findings.find(x=>x.id===id);
    if(ex){
      if(magnitude > ex.magnitude){
        ex.magnitude = magnitude;
        ex.prominence = Math.max(ex.prominence, prominence);
        ex.evidenceRef = evidenceRef;
      }
      return;
    }
    state.findings.push({
      id, key, disparity, segment, magnitude,
      prominence,
      concentration:0,
      score:0,
      recommend:"",
      evidenceRef
    });
  }

  function scanDoc(doc){
    const prominence = {};
    for(const d of DISPARITIES){ prominence[d.key]=0; }

    for(let i=0;i<doc.textByPage.length;i++){
      const t = doc.textByPage[i] || "";
      const lower = t.toLowerCase();

      // prominence by keywords
      for(const d of DISPARITIES){
        for(const kw of d.keywords){
          if(lower.includes(kw.toLowerCase())){ prominence[d.key] += 1; break; }
        }
      }

      // Transportation overall
      const tr = findPercentNear(t, "transportation");
      if(tr){
        recordEvidence("Transportation barrier", tr.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Overall", tr.val, prominence["transport"], `${doc.name} p.${i+1}`);
        if(state.transport.overall==null) state.transport.overall = tr.val;
      }
      // Transportation 65-74
      const tr6574 = findAge6574Transport(t);
      if(tr6574){
        recordEvidence("Transportation barrier", tr6574.snippet, doc.name, i+1);
        addFinding("transport", "Transportation barrier", "Age 65–74", tr6574.val, prominence["transport"], `${doc.name} p.${i+1}`);
        state.transport.age6574 = tr6574.val;
      }

      // Other disparities
      for(const d of DISPARITIES){
        if(d.key==="transport") continue;
        const primary = d.keywords[0];
        const p = findPercentNear(t, primary.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        if(p){
          recordEvidence(d.label, p.snippet, doc.name, i+1);
          addFinding(d.key, d.label, "Overall", p.val, prominence[d.key], `${doc.name} p.${i+1}`);
        }
      }
    }
  }

  function computeMateriality(){
    // Compute concentration per key (subgroup - overall)
    const byKey = {};
    for(const f of state.findings){
      if(!byKey[f.key]) byKey[f.key]=[];
      byKey[f.key].push(f);
    }
    for(const key of Object.keys(byKey)){
      const list = byKey[key];
      const overall = list.find(x=>x.segment==="Overall");
      for(const f of list){
        f.concentration = (f.segment!=="Overall" && overall) ? Math.max(0, f.magnitude - overall.magnitude) : 0;
      }
    }

    // Materiality score:
    // magnitude (0-60), concentration (0-25), prominence (0-15)
    // transportation amplification: if 65–74 exists and overall exists, add bonus up to +10
    let transportBonus = 0;
    if(state.transport.overall!=null && state.transport.age6574!=null && state.transport.overall>0){
      const amp = state.transport.age6574 / state.transport.overall;
      transportBonus = clamp((amp-1)*8, 0, 10); // up to 10 points bonus
    }

    for(const f of state.findings){
      const magScore = clamp((f.magnitude/30)*60, 0, 60);
      const concScore = clamp((f.concentration/15)*25, 0, 25);
      const promScore = clamp((f.prominence/6)*15, 0, 15);
      let score = Math.round(magScore + concScore + promScore);
      if(f.key==="transport") score = clamp(score + Math.round(transportBonus), 0, 100);
      f.score = score;
      f.recommend = (score>=70) ? "Advance (high)" : (score>=55 ? "Advance (moderate)" : "Defer/monitor");
    }
    state.findings.sort((a,b)=>b.score-a.score);
  }

  function buildOpportunities(){
    const bestByKey = {};
    for(const f of state.findings){
      if(!bestByKey[f.key]) bestByKey[f.key]=f;
    }

    // Always include transportation opportunity (requirement), score based on findings if present
    const opps = [];

    function scoreOpportunity(eligibilityClarity, responsiveness, attributionStrength, docBurden){
      return Math.round(0.30*eligibilityClarity + 0.30*responsiveness + 0.25*attributionStrength + 0.15*(100-docBurden));
    }

    // Attribution heuristic
    const attribution = 70; // default; can be enhanced later if we parse AA geos
    const scope = "Prefer AA attribution: document beneficiary location (ZIP/tract/county) and service delivery within AA; if broader, document proportional benefit.";

    // Transportation (NEMT) — explicit criterion
    {
      const f = bestByKey.transport || {score:55}; // keep it evaluable even if CHNA extraction fails
      const eligibility = 90; // strong
      const responsiveness = clamp(f.score, 0, 100);
      const burden = 35;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Transportation-to-care (NEMT) — missed appointment mitigation",
        kind:"nmt",
        tests:"Service • Investment (as structured) • CD Loans (as structured)",
        criterion: CRA_CRITERIA.nmt.criterion + " " + CRA_CRITERIA.nmt.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA excerpt(s) with overall + age-band differential; target population definition (LMI and/or qualifying segments); service area map; vendor/partner agreement; invoices; ride logs; beneficiary counts; monitoring report cadence."
      });
    }

    // Food
    if(bestByKey.food){
      const f = bestByKey.food;
      const eligibility = 80;
      const responsiveness = clamp(f.score,0,100);
      const burden = 45;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Food access support — distribution / vouchers / meal supports",
        kind:"food",
        tests:"Investment • Service (depending on structure)",
        criterion: CRA_CRITERIA.food.criterion + " " + CRA_CRITERIA.food.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA food measure; LMI targeting method; partner agreement; distribution logs; invoices; beneficiary counts; monitoring plan."
      });
    }

    // Access
    if(bestByKey.access){
      const f = bestByKey.access;
      const eligibility = 75;
      const responsiveness = clamp(f.score,0,100);
      const burden = 50;
      const score = scoreOpportunity(eligibility, responsiveness, attribution, burden);
      opps.push({
        opp:"Care navigation / referral infrastructure — access enablement",
        kind:"care",
        tests:"Service • Investment (as structured)",
        criterion: CRA_CRITERIA.care.criterion + " " + CRA_CRITERIA.care.cite,
        strength: score>=75 ? "Strong" : (score>=60 ? "Moderate" : "Weak"),
        score,
        scope,
        checklist:"CHNA access barrier evidence; workflow description; staffing records; referral counts; LMI targeting; monitoring plan."
      });
    }

    opps.sort((a,b)=>b.score-a.score);
    state.opportunities = opps;
    state.selectedOpp = opps.length ? opps[0] : null;
  }

  function tier3Unlocked(){
    return state.opportunities.some(o=>o.score>=60);
  }

  // ------------------------------
  // Rendering
  // ------------------------------
  let chartMateriality=null, chartROI=null, chartTrend=null;

  function strengthBadge(str){
    if(str==="Strong") return `<span class="badge b-strong">Strong</span>`;
    if(str==="Moderate") return `<span class="badge b-mod">Moderate</span>`;
    return `<span class="badge b-weak">Weak</span>`;
  }

  function renderTransportSpotlight(){
    const o = state.transport.overall;
    const a = state.transport.age6574;
    document.getElementById("t_overall").textContent = (o==null) ? "—" : fmtPct(o);
    document.getElementById("t_6574").textContent = (a==null) ? "—" : fmtPct(a);
    if(o!=null && a!=null && o>0){
      const amp = a/o;
      document.getElementById("t_amp").textContent = `${amp.toFixed(1)}×`;
    }else{
      document.getElementById("t_amp").textContent = "—";
    }
  }

  function renderTier1(){
    // KPIs
    if(state.findings.length){
      const top = state.findings[0];
      document.getElementById("kpi_top").textContent = `${top.disparity} (${top.score})`;
      document.getElementById("kpi_top_hint").textContent = `Magnitude ${fmtPct(top.magnitude)} • Prominence ${top.prominence} • Δ ${top.concentration.toFixed(1)}.`;
      const subs = state.findings.filter(x=>x.segment!=="Overall").sort((a,b)=>b.concentration-a.concentration);
      if(subs.length){
        const s = subs[0];
        document.getElementById("kpi_conc").textContent = `${s.disparity} Δ${s.concentration.toFixed(1)}% (${s.segment})`;
      }else{
        document.getElementById("kpi_conc").textContent = "—";
      }
      const shortlist = state.findings.filter(f=>f.score>=55).length;
      document.getElementById("kpi_shortlist").textContent = `${shortlist}`;
      const angle = (state.transport.overall!=null && state.transport.age6574!=null) ?
        "Transportation appears small overall, but materially higher in older adults — strong case for targeted NEMT." :
        "Use highest materiality disparities to form a joint bank–hospital decision memo.";
      document.getElementById("kpi_angle").textContent = angle;
    }

    // Materiality table
    const tbl = document.getElementById("tbl_materiality");
    if(!state.findings.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>No results yet.</td></tr>";
    }else{
      let html = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr>";
      for(const f of state.findings.slice(0,10)){
        html += `<tr>
          <td><b>${escapeHtml(f.disparity)}</b></td>
          <td>${escapeHtml(f.segment)}</td>
          <td class="mono">${fmtPct(f.magnitude)}</td>
          <td class="mono">${f.concentration.toFixed(1)}%</td>
          <td class="mono">${f.prominence}</td>
          <td class="mono"><b>${f.score}</b></td>
          <td>${escapeHtml(f.recommend)}</td>
          <td class="mono">${escapeHtml(f.evidenceRef||"—")}</td>
        </tr>`;
      }
      tbl.innerHTML = html;
    }

    // Materiality chart
    const top = state.findings.slice(0,8);
    const labels = top.map(f=>`${f.disparity}${f.segment!=="Overall" ? " ("+f.segment+")" : ""}`);
    const vals = top.map(f=>f.score);
    if(chartMateriality) chartMateriality.destroy();
    chartMateriality = new Chart(document.getElementById("chart_materiality"), {
      type:"bar",
      data:{labels, datasets:[{label:"Materiality (0–100)", data:vals}]},
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
          y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true, max:100}
        }
      }
    });

    // Tier 1 recs
    const rec = [];
    if(state.transport.overall!=null && state.transport.age6574!=null){
      rec.push(`Transportation: overall ${fmtPct(state.transport.overall)} vs age 65–74 ${fmtPct(state.transport.age6574)} (amplification ${(state.transport.age6574/state.transport.overall).toFixed(1)}×). Treat as a high-value access lever (missed appointments).`);
    }
    const adv = state.findings.filter(f=>f.score>=70).slice(0,3);
    if(adv.length){
      rec.push(`Advance now: ${adv.map(x=>x.disparity).join(", ")}.`);
    }else{
      rec.push("Advance now: highest scoring disparity and validate geography + target segment in Tier 2.");
    }
    rec.push("Create a joint bank–hospital memo: (1) documented need, (2) target segment/geography, (3) CRA criterion satisfied, (4) documentation plan, (5) cost baseline and KPI monitoring.");
    document.getElementById("tier1_recs").textContent = rec.join(" ");
  }

  function renderEvidence(){
    const tbl = document.getElementById("tbl_evidence");
    if(!state.evidence.length){
      tbl.innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>No evidence captured yet.</td></tr>";
      return;
    }
    const slice = state.evidence.slice(-25).reverse();
    let html = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr>";
    for(const e of slice){
      html += `<tr>
        <td>${escapeHtml(e.disparity)}</td>
        <td>${escapeHtml(e.snippet)}</td>
        <td class="mono">${escapeHtml(e.doc)}</td>
        <td class="mono">${e.page}</td>
      </tr>`;
    }
    tbl.innerHTML = html;
  }

  function renderTier2(){
    const tbl = document.getElementById("tbl_cra");
    if(!state.opportunities.length){
      tbl.innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>No opportunities yet.</td></tr>";
      return;
    }
    let html = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr>";
    for(const o of state.opportunities){
      html += `<tr>
        <td><b>${escapeHtml(o.opp)}</b></td>
        <td>${escapeHtml(o.tests)}</td>
        <td>${escapeHtml(o.criterion)}</td>
        <td>${strengthBadge(o.strength)}</td>
        <td class="mono"><b>${o.score}</b></td>
        <td>${escapeHtml(o.scope)}</td>
        <td>${escapeHtml(o.checklist)}</td>
      </tr>`;
    }
    tbl.innerHTML = html;

    const top = state.opportunities[0];
    document.getElementById("t2_best").textContent = `${top.score}`;
    document.getElementById("t2_best_hint").textContent = top.opp;

    const tOpp = state.opportunities.find(x=>x.kind==="nmt");
    document.getElementById("t2_transport").textContent = tOpp ? `${tOpp.score} (${tOpp.strength})` : "—";
    document.getElementById("t2_crit").textContent = tOpp ? tOpp.criterion : "—";
    document.getElementById("t2_packet").textContent = tOpp ? "CHNA evidence + LMI targeting + AA attribution + invoices + service logs + beneficiary counts + monitoring" : "—";

    document.getElementById("top_t2").textContent = `${top.score}`;

    // Gate
    const unlocked = tier3Unlocked();
    const dot = document.getElementById("gateDot");
    dot.classList.remove("good","bad");
    if(unlocked){ dot.classList.add("good"); document.getElementById("gateText").textContent = "Tier 3 unlocked (Tier 2 score ≥ 60)"; }
    else { dot.classList.add("bad"); document.getElementById("gateText").textContent = "Tier 3 locked until Tier 2 score ≥ 60"; }

    // Prompts
    document.getElementById("exam_prompts").textContent =
      "1) Document the disparity + affected segment (CHNA excerpt with page). 2) State the CRA qualifying criterion satisfied (and why benefit is targeted to LMI/qualifying population). 3) Define assessment area attribution (who benefited, where). 4) Provide invoices/contracts and beneficiary counts. 5) Define baseline metric + monitoring cadence.";
  }

  function setTier3FromOpportunity(opp){
    if(!opp) return;
    document.getElementById("inp_activity").value = opp.kind;
    // Nudge parameters for NEMT: barrier share proxy from transport overall if present
    if(opp.kind==="nmt" && state.transport.overall!=null){
      const proxy = clamp(state.transport.overall*3.0, 5, 70);
      document.getElementById("inp_share").value = proxy.toFixed(1);
    }
  }

  function runTier3(){
    const activity = document.getElementById("inp_activity").value;
    const months = parseInt(document.getElementById("inp_months").value||"12",10);

    const annual = parseFloat(document.getElementById("inp_annual").value||"0");
    const baseRate = parseFloat(document.getElementById("inp_base").value||"0")/100;
    const share = parseFloat(document.getElementById("inp_share").value||"0")/100;
    const red = parseFloat(document.getElementById("inp_red").value||"0")/100;

    const benefitPer = parseFloat(document.getElementById("inp_benefit").value||"0");
    const startup = parseFloat(document.getElementById("inp_startup").value||"0");
    const fixed = parseFloat(document.getElementById("inp_fixed").value||"0");
    const varCost = parseFloat(document.getElementById("inp_var").value||"0");
    const unitsPer = parseFloat(document.getElementById("inp_units").value||"1");

    const baselineDisrupt = annual*baseRate;
    const barrierDisrupt = baselineDisrupt*share;
    const prevented = barrierDisrupt*red;

    const unitsAnnual = prevented*unitsPer;
    const grossAnnual = prevented*benefitPer;

    // cost over horizon: startup + fixed*months + variable*(annualUnits*months/12)*varCost
    const totalCostH = startup + fixed*months + (unitsAnnual*(months/12)*varCost);
    const annualCost = totalCostH*(12/months);
    const netAnnual = grossAnnual - annualCost;

    document.getElementById("kpi_cost").textContent = fmtMoney(annualCost);
    document.getElementById("kpi_gross").textContent = fmtMoney(grossAnnual);
    document.getElementById("kpi_net").textContent = fmtMoney(netAnnual);

    // Charts
    if(chartROI) chartROI.destroy();
    chartROI = new Chart(document.getElementById("chart_roi"),{
      type:"bar",
      data:{labels:["Annual benefit","Annual cost","Annual net"], datasets:[{label:"$", data:[grossAnnual, annualCost, netAnnual]}]},
      options:{plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}, beginAtZero:true}}}
    });

    const labels = Array.from({length:months}, (_,i)=>`M${i+1}`);
    const monthlyBenefit = grossAnnual/12;
    const monthlyUnits = unitsAnnual/12;
    const monthlyCost = (startup/months) + fixed + (monthlyUnits*varCost);
    const monthlyNet = monthlyBenefit - monthlyCost;

    const netSeries = labels.map(()=>monthlyNet);
    let cum=0; const cumSeries = netSeries.map(v=>(cum+=v));
    if(chartTrend) chartTrend.destroy();
    chartTrend = new Chart(document.getElementById("chart_trend"),{
      type:"line",
      data:{labels, datasets:[
        {label:"Monthly net", data:netSeries, tension:.25},
        {label:"Cumulative net", data:cumSeries, tension:.25}
      ]},
      options:{plugins:{legend:{labels:{color:"#2f4556"}}},
        scales:{x:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}},
                y:{ticks:{color:"#2f4556"}, grid:{color:"rgba(11,31,51,.08)"}}}}
    });

    // Audit memo
    const topOpp = state.selectedOpp || state.opportunities[0] || null;
    const crit = topOpp ? topOpp.criterion : CRA_CRITERIA[activity]?.criterion || "—";
    const memo =
`TIER 3 — TOTAL PROGRAM COST & ROI (Audit-ready)

Selected activity: ${activity}
CRA criterion satisfied: ${crit}

A) Documented disparity (Tier 1)
- Transportation overall: ${state.transport.overall==null? "Not detected" : fmtPct(state.transport.overall)}
- Transportation age 65–74: ${state.transport.age6574==null? "Not detected" : fmtPct(state.transport.age6574)}
- Amplification: ${(state.transport.overall && state.transport.age6574) ? (state.transport.age6574/state.transport.overall).toFixed(1)+"×" : "—"}

B) Baseline assumptions
- Annual touchpoints: ${fmtInt(annual)}
- Baseline disruption rate: ${(baseRate*100).toFixed(1)}%
- Share attributable to barrier: ${(share*100).toFixed(1)}%
- Reduction in barrier disruptions: ${(red*100).toFixed(1)}%
- Benefit per prevented disruption: ${fmtMoney(benefitPer)}

C) Total program cost baseline (answers: “How much does it cost?”)
- Startup cost (one-time): ${fmtMoney(startup)}
- Fixed monthly cost: ${fmtMoney(fixed)} per month
- Variable unit cost: ${fmtMoney(varCost)} per unit
- Units per prevented disruption: ${unitsPer.toFixed(2)}
- Estimated annual units: ${fmtInt(unitsAnnual)}
- Total cost over horizon (${months} mo): ${fmtMoney(totalCostH)}
- Annualized program cost: ${fmtMoney(annualCost)}

D) Modeled annual impact
- Baseline disruptions: ${fmtInt(baselineDisrupt)}
- Barrier disruptions: ${fmtInt(barrierDisrupt)}
- Prevented disruptions: ${fmtInt(prevented)}
- Annual gross benefit: ${fmtMoney(grossAnnual)}
- Annual net impact: ${fmtMoney(netAnnual)}

E) Evidence packet (minimum)
- CHNA excerpt(s) + page refs, including subgroup differential
- Target population definition (LMI method) + geography attribution
- Contracts/invoices + service logs + beneficiary counts
- Monitoring cadence with baseline vs observed + corrective actions

Generated: ${new Date().toISOString()}`;
    document.getElementById("audit_out").textContent = memo;
  }

  // ------------------------------
  // Export
  // ------------------------------
  function exportReport(){
    const report = {
      generated_at: new Date().toISOString(),
      docs: state.docs.map(d=>({name:d.name, pages:d.pages, type:d.type})),
      transport: state.transport,
      tier1_findings: state.findings,
      tier2_opportunities: state.opportunities,
      evidence: state.evidence.slice(-100)
    };
    const blob = new Blob([JSON.stringify(report,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "chna_cra_dashboard_report.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ------------------------------
  // Tabs
  // ------------------------------
  function setView(view){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById("view_"+view).classList.add("active");
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.getElementById("tab_"+view).classList.add("active");
  }
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setView(btn.dataset.view));
  });

  // ------------------------------
  // Buttons
  // ------------------------------
  document.getElementById("btn_export").addEventListener("click", exportReport);

  document.getElementById("btn_reset").addEventListener("click", ()=>{
    clearErr();
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};
    document.getElementById("docs_count").textContent="0";
    document.getElementById("ev_count").textContent="0";
    document.getElementById("top_t2").textContent="—";
    document.getElementById("tbl_materiality").innerHTML="";
    document.getElementById("tbl_evidence").innerHTML="";
    document.getElementById("tbl_cra").innerHTML="";
    document.getElementById("audit_out").textContent="";
    if(chartMateriality) chartMateriality.destroy();
    if(chartROI) chartROI.destroy();
    if(chartTrend) chartTrend.destroy();
    renderTransportSpotlight();
    showOk("Reset complete.");
  });

  document.getElementById("btn_demo").addEventListener("click", ()=>{
    clearErr();
    // Demo based on your exact framing: 2.7% overall, 8.5% age 65-74
    const demoText =
      "Why did you not get or delay getting the preventative care you thought you needed? Total: I had transportation problems 2.7%. " +
      "Age 65-74: I had transportation problems 8.5%. " +
      "Of patients surveyed, 7.5% reported food insecurity and 6% reported housing needs. " +
      "Unweighted count 61. Martin County ZIP 56031.";
    state.docs=[{name:"Demo_CHNA.pdf", type:"pdf", pages:1, textByPage:[demoText]}];
    state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};

    scanDoc(state.docs[0]);
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    showOk("Demo loaded (transportation differential).");
  });

  document.getElementById("btn_process").addEventListener("click", async ()=>{
    clearErr();
    const files = Array.from(document.getElementById("file_input").files || []);
    if(!files.length){
      showErr("No files selected.");
      return;
    }
    state.docs=[]; state.evidence=[]; state.findings=[]; state.opportunities=[]; state.selectedOpp=null;
    state.transport={overall:null, age6574:null};

    for(const f of files){
      const ext = (f.name.split(".").pop()||"").toLowerCase();
      let parsed=null;
      try{
        if(ext==="pdf") parsed = await extractPdfText(f);
        else if(ext==="txt") parsed = await extractTxt(f);
        else continue;
        state.docs.push({name:f.name, type:ext, pages:parsed.pages, textByPage:parsed.textByPage});
      }catch(e){
        showErr(`Error parsing ${escapeHtml(f.name)}. Consider uploading a text version if scanned.`);
      }
    }

    // Scan
    for(const d of state.docs){ scanDoc(d); }
    computeMateriality();
    buildOpportunities();
    state.selectedOpp = state.opportunities[0] || null;

    document.getElementById("docs_count").textContent = state.docs.length;
    document.getElementById("ev_count").textContent = state.evidence.length;

    renderTransportSpotlight();
    renderTier1();
    renderEvidence();
    renderTier2();
    showOk(`Processed ${state.docs.length} document(s).`);
  });

  document.getElementById("btn_use_top").addEventListener("click", ()=>{
    if(!state.opportunities.length){
      showErr("No Tier 2 opportunities available yet.");
      return;
    }
    state.selectedOpp = state.opportunities[0];
    setTier3FromOpportunity(state.selectedOpp);
    setView("t3");
    showOk("Tier 3 prefilled using top Tier 2 opportunity.");
  });

  document.getElementById("btn_autofill").addEventListener("click", ()=>{
    if(!state.selectedOpp) state.selectedOpp = state.opportunities[0] || null;
    if(state.selectedOpp) setTier3FromOpportunity(state.selectedOpp);
    showOk("Tier 3 auto-fill applied from Tier 2.");
  });

  document.getElementById("btn_run").addEventListener("click", runTier3);

  // Initial render placeholders
  renderTransportSpotlight();
  document.getElementById("tbl_materiality").innerHTML = "<tr><th>Disparity</th><th>Segment</th><th>Magnitude</th><th>Δ Concentration</th><th>Prominence</th><th>Score</th><th>Recommendation</th><th>Evidence</th></tr><tr><td colspan='8'>Upload documents and click Process Files.</td></tr>";
  document.getElementById("tbl_evidence").innerHTML = "<tr><th>Disparity</th><th>Snippet</th><th>Doc</th><th>Page</th></tr><tr><td colspan='4'>—</td></tr>";
  document.getElementById("tbl_cra").innerHTML = "<tr><th>Opportunity</th><th>CRA test mapping</th><th>Criterion satisfied</th><th>Strength</th><th>Score</th><th>Scope guidance</th><th>Application packet checklist</th></tr><tr><td colspan='7'>—</td></tr>";
</script>
</body>
</html>
